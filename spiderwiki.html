<head>
		<title>Spider Wiki Helper</title>
		<meta name="viewport" content="user-scalable=no, width=device-width">
		<meta charset="UTF-8">

		<link href="css/bootstrap.min.css" rel="stylesheet" >
		<link href="css/style.css" rel="stylesheet" type="text/css">

		<script src="js/jquery.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
</head>

<body>
	Citation: <input name="src" id="src" />
	<button onclick="compute()">Go</button><br/>
	Wiki Ref:<br/>
	<textarea id="wiki_ref"></textarea><br/><br/>
	<hr>
	
	Copy Paste Gen Page: <input name="gen_src" id="gen_src" /><br/>
	Number: <input name="gen_num" id="gen_num" /><br/>
	Image: <input name="img" id="img" /><br/>
	Image Cap: <input name="img_cap" id="img_cap" /><br/>
	Other Text: <input name="other_txt" id="other_txt" />
	<button onclick="compute2()">Go</button><br/>
	Wiki page:
	<textarea id="wiki_page"></textarea><br/><br/>
</body>

<script>
	var authors = {
		"Dahl":"Friedrich Dahl",
		"Emerton":"James Henry Emerton",
		"Keyserling":"Eugen von Keyserling",
		"C. L. Koch":"Ludwig Carl Christian Koch",
		"L. Koch":"Ludwig Carl Christian Koch",
		"Kulczyński":"Władysław Kulczyński",
		"Kulczynski":"Władysław Kulczyński",
		"Lehtinen":"Pekka T. Lehtinen",
		"Marx":"George Marx",
		"Menge":"Anton Menge",
		"Millidge":"A. F. Millidge",
		"F. O. Pickard-Cambridge":"Frederick Octavius Pickard-Cambridge", 
		"O. Pickard-Cambridge":"Octavius Pickard-Cambridge",
		"Perty":"Maximilian Perty",
		"Platnick":"Norman I. Platnick",
		"Pocock":"Reginald Innes Pocock",
		"Prószyński":"Jerzy Prószyński",
		"Proszynski":"Jerzy Prószyński",
		"Roewer":"Carl Friedrich Roewer",
		"Saaristo":"Michael Saaristo",
		"Strand":"Embrik Strand",
		"Simon":"Eugène Simon",
		"Thorell":"Tamerlan Thorell"
	};
	var families = [
		["Antrodiaetidae", "folding trapdoor spiders"],
		["Atracidae","Australian funnel web spiders"],
		["Atypidae","purseweb spiders"],
		["Barychelidae","brushed trapdoor spiders"],
		["Ctenizidae","trapdoor spiders"],
		["Cyrtaucheniidae","wafer trapdoor spiders"],
		["Dipluridae","curtain web spiders"],
		["Idiopidae","armored trapdoor spiders"],
		["Mecicobothriidae","dwarf tarantulas"],
		["Migidae","tree trapdoor spiders"],
		["Paratropididae","baldlegged spiders"],
		["Theraphosidae","tarantulas"],
		["Amaurobiidae","tangled nest spiders"],
		["Anyphaenidae","anyphaenid sac spiders"],
		["Araneidae","orb-weaver spiders"],
		["Archaeidae","assassin spiders"],
		["Clubionidae","sac spiders"],
		["Corinnidae","corinnid sac spiders"],
		["Ctenidae","wandering spiders"],
		["Deinopidae","net-casting spiders"],
		["Desidae","intertidal spiders"],
		["Diguetidae","coneweb spiders"],
		["Drymusidae","false violin spiders"],
		["Dysderidae","woodlouse hunter spiders"],
		["Eresidae","velvet spiders"],
		["Filistatidae","crevice weavers"],
		["Gnaphosidae","flat-bellied ground spiders"],
		["Gradungulidae","large-clawed spiders"],
		["Hahniidae","dwarf sheet spiders"],
		["Hersiliidae","tree trunk spiders"],
		["Hypochilidae","lampshade spiders"],
		["Liocranidae","liocranid sac spiders"],
		["Linyphiidae","dwarf spiders"],
		["Lycosidae","wolf spiders"],
		["Malkaridae","shield spiders"],
		["Mimetidae","pirate spiders"],
		["Miturgidae","long-legged sac spiders"],
		["Mysmenidae","spurred orb-weavers"],
		["Nesticidae","cave cobweb spiders"],
		["Ochyroceratidae","midget ground weavers"],
		["Oecobiidae","disc web spiders"],
		["Oonopidae","goblin spiders"],
		["Oxyopidae","lynx spiders"],
		["Palpimanidae","palp-footed spiders"],
		["Philodromidae","running crab spiders"],
		["Pholcidae","cellar spiders"],
		["Pisauridae","nursery web spiders"],
		["Plectreuridae","plectreurid spiders"],
		["Prodidomidae","long-spinneret ground spiders"],
		["Salticidae","jumping spiders"],
		["Scytodidae","spitting spiders"],
		["Segestriidae","tube dwelling spiders"],
		["Selenopidae","wall spiders"],
		["Sicariidae","recluse spider"],
		["Sparassidae","huntsman spiders"],
		["Stiphidiidae","sheetweb spiders"],
		["Symphytognathidae","dwarf orb-weavers"],
		["Telemidae","long-legged cave spiders"],
		["Tetragnathidae","long-jawed orb-weavers"],
		["Theridiidae","tangle-web spiders"],
		["Theridiosomatidae","ray spiders"],
		["Thomisidae","crab spiders"],
		["Uloboridae","cribellate orb-weavers"],
		["Zodariidae","ant spiders"]
	];
	
  function compute() {
    $("#wiki_src").val(ref($("#src").val()));
  }

function compute2() {
	$("#wiki_page").val(get_page_data($("#num").val(), $("#gen_src").val(), $("#img").val(), $("#img_cap").val(), $("#other_txt").val()));
}
 
function ref (ref = "") {
  var result = {};
  var cite_patt = /[\s]*(\S[\s\S]*)\(([0-9]+)[a-zA-Z]*\)[\.\s]*([\s\S]+) ([0-9()a-zA-Z]+)\:([\s\S]+)download pdf/;
  var info = cite_patt.exec(ref);
  var ref_name = "";

  if (info[1].includes("&")) {
    var allnames = info[1].replace("&",",").split(",");
    for (var i = 0; i < allnames.length; i += 2) {
      result['last' + (i/2 + 1)] = allnames[i].trim();
      result['first' + (i/2 + 1)] = allnames[i + 1].trim();
    }
    ref_name = result['last1'].substr(0,4) + info[2];
  } else {
    var tmp_name = info[1].split(',');
    result['last'] = tmp_name[0].trim();
    result['first'] = tmp_name[1].trim();
    ref_name = result['last'].substr(0,4) + info[2];
  }
  result['year'] = info[2];

  var pages_patt = /([0-9]+)[\s]*([\-]*)[\s]*([0-9]*)/;
  var tmp_ans = pages_patt.exec(info[5].replace("download pdf", ""));
  tmp_ans.shift();
  result['pages'] = tmp_ans.join('');

  tmp_ans = info[3].split(".");
  result['title'] = "";
  for (var i = 0; i < tmp_ans.length; i++) {
    if (i == tmp_ans.length - 1) {
      result['journal'] = tmp_ans[i].trim();
    } else {
      result['title'] += ((result['title'].length > 0) ? ". " : "") + tmp_ans[i].trim();
    }
  }
  if (info[4].includes("(")) {
    var iss_patt = /([^()]*)\(([^()]*)\)/;
    tmp_ans = iss_patt.exec(info[4]);
    result['volume'] = tmp_ans[1];
    result['issue'] = tmp_ans[2];
  } else {
    result['volume'] = info[4].trim();
  }

  var wiki_cite = "<ref name=" + ref_name + ">{{cite journal";
  for (var p in result) {
    wiki_cite += "| " + p + "=" + result[p];
  }
  return wiki_cite + "}}</ref>";
}

function get_page_data(gen_num = null, str = "", img = "", img_cap = "") {
	if (str.length == 0) { return ""; }
	/*
  str = $("#gen_src").val();
  gen_num = $("#gen_num").val();
  img = $("#img").val();
  img_cap = $("#img_cap").val();
	*/

	var result = "{{Short description|Genus of spiders}}";
	var list = {};

  var gen_patt = /Gen.\s([^\s]+)\s([\s\S]*,\s[0-9]{4}[)\s]*)\[/;
  var tmp = gen_patt.exec(str);

  list['genus'] = tmp[1].trim();
  list['genus_auth'] = tmp[2].trim();

  var fam_patt = /Family:\s([\S]+)\s/;
  tmp = fam_patt.exec(str);
  list['family'] = tmp[1].trim();

  var z = 0;
  list['species'] = [];
  do {
    var re = new RegExp("(" + list['genus'] + "\\s[\\S]+)\\s([^\\d]+,\\s[0-9]{4}[^\\s]*)[\\s\\*]+\\|[\\smf]+\\|([^\\[]+)\\[");
    tmp = re.exec(str);
    if (tmp) {
      list['species'].push(tmp);
      if (tmp[0].includes("*")) {
        list['type_species'] = tmp[1];
      }
      list['species'][list['species'].length - 1][3] = list['species'][list['species'].length - 1][3].trim();
      str = str.replace(tmp[0], "");
    }
    z++;
  } while (tmp && z < 1000);

  list['fam_nickname'] = "";
  for (var i = 0; i < families.length; i++) {
    if (list['family'].toLowerCase().localeCompare(families[i][0].toLowerCase()) == 0) {
      list['fam_nickname'] = families[i][1];
      break;
    }
  }

  if (str.includes("In synonymy:")) {
    z = 0;
    var s_patt = /In synonymy:([\s\S]*)Gen./;
		if (s_patt.exec(str)) {
    	list['synonyms'] = [s_patt.exec(str)[1].trim().split(" ")[0]];
    	var syn_group = s_patt.exec(str)[1];
    	do {
      	tmp_s_patt = /\)\s([^=]+) = /;
      	tmp = tmp_s_patt.exec(syn_group);
      	if (tmp) {
        	list['synonyms'].push(tmp[1].split(" ")[0]);
        	syn_group = syn_group.replace(tmp[1], "");
      	}
      	z++;
    	} while (tmp && z < 100);
		} else { list['synonyms'] = []; }
  } else { list['synonyms'] = []; }

  result += "\n{{Automatic taxobox\n| taxon = " + list['genus'] +
		"\n| image = " + img + "\n| image_caption = " + img_cap +
    "\n| authority = " + list["genus_auth"] + "<ref name=NMBE />" +
    "\n| type species = ''[[" + list['type_species'] + "]]''" +
    "\n| subdivision_ranks = Species" +
    "\n| subdivision = " + list['species'].length + ", see text\n";
  if (list['synonyms'].length > 0) {
    result += "| synonyms =\n";
    for (var i = 0; i < list['synonyms'].length; i++) {
      result += "*''" + list['synonyms'][i] + "''\n";
    }
  }
  result += "}}\n'''''" + list['genus'] + "''''' is a [[genus]] of ";

  if (list['fam_nickname'].length > 0) {
    result += "[[" + list['family'] + "|" + list['fam_nickname'] + "]]";
  } else {
    result += "spiders in the " + list['family'] + " family";
  }
  result += " first described by ";
 
  var auth_names = list['genus_auth'].split(',');
  for (var i = 0; i < auth_names.length - 1; i++) {
    if (authors[auth_names[i].trim()]) {
      auth_names[i] = "[[" + authors[auth_names[i].trim()] + "]]";
    }
    result += auth_names[i];
    if (i < auth_names.length - 2) { result += ", "; }
    if (i == auth_names.length - 1 && auth_names.length > 2) { result += " & "; }
  }
  result += " in " + auth_names[auth_names.length - 1].trim() + ".\n\n";

  var curdate = new Date();
  var month = (((curdate.getMonth()+1) < 10) ? ("0" + (curdate.getMonth()+1)) : (curdate.getMonth()+1));
  result += "== Species ==\n{{as of|" + curdate.getUTCFullYear() + "|" +
    month + "}} it contains " + list['species'].length + " species:" +
    "<ref name=NMBE>{{cite web|title=Gen. " + list['genus'] + " " +
    list['genus_auth'] + "| website=World Spider Catalog" +
    "| publisher=Natural History Museum Bern| accessdate=" + 
    curdate.getFullYear() + "-" + month + "-" +
    curdate.getDate() + "| url=http://www.wsc.nmbe.ch/";
  if (gen_num != null) {
    result += "/genus/" + gen_num + "/" + list['genus'];
  }
  result += "}}</ref>\n" +
    "<!--When updating this list, please also update the list at [[List of " +
    list['family'] + " species#" + list['genus'] + "]]-->";

  list['locations'] = [];
  for (var i = 0; i < list['species'].length; i++) {
    result += "\n*''[[" + list['species'][i][1] + "]]'' <small>" +
    list['species'][i][2] + "</small> — " + list['species'][i][3];
		
		console.log("===");
		console.log(list['species'][i][3]);
		
		var tmp_locs = list['species'][i][3].replace(/\([^\)\(]*\)/g, "").split(',');
		
		console.log(tmp_locs);
		
    for (var j = 0; j < tmp_locs.length; j++) {
			tmp_locs[j] = tmp_locs[j].trim();
	    
	    console.log(tmp_locs[j]);
	    
      if (!list['locations'].includes(tmp_locs[j])) {
        list['locations'].push(tmp_locs[j]);
      }
    }
  }

  result += "\n\n==References==\n{{Reflist}}\n\n" +
    "[[Category:" + list['family'] + "]]\n";
  for (var i = 0; i < list['locations'].length; i++) {
    result += "[[Category:Spiders of " + list['locations'][i] + "]]\n";
  }
  result += "\n{{" + list['family'] + "-stub}}";
  return result;
}
	
</script>
