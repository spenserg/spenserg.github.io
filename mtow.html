<head>
	<title>FKeys Helper</title>
	<meta name="viewport" content="user-scalable=no, width=device-width">
	<meta charset="UTF-8">

	<link href="css/bootstrap.min.css" rel="stylesheet" >
	<link href="css/style.css" rel="stylesheet" type="text/css">

	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>

	<script src="js/aviation/get_routes.js" type="text/javascript"></script>
	<script src="js/aviation/airports.js" type="text/javascript"></script>
	<script src="js/aviation/fkeys.js" type="text/javascript"></script>

	<script src="js/aviation/clt_departures.js" type="text/javascript"></script>
	<script src="js/aviation/dfw_departures.js" type="text/javascript"></script>
	<script src="js/aviation/lax_departures.js" type="text/javascript"></script>
	<script src="js/aviation/mia_departures.js" type="text/javascript"></script>
	<script src="js/aviation/ord_departures.js" type="text/javascript"></script>
	<script src="js/aviation/phx_departures.js" type="text/javascript"></script>

	<style>
		.selected {font-weight:bold;color:black;font-size:20;border:4px solid black}
	</style>
</head>

<body>
	FKeys Page: <textarea id="outbound" rows="5">https://prod-1-public.fk.aa.com</textarea>&nbsp;
	<textarea id="ob_copy" rows="5" hidden></textarea>&nbsp;&nbsp
	<button id="go_button" onclick="compute()">Go</button>&nbsp;&nbsp;<button onclick="clear_input(0)">Clear</button>&nbsp;&nbsp;<button onclick="restore_last()">Refresh/Run Previous</button><br/>
	<div id="total"></div>
</body>

<script>
const M738 = ["3RA", "3RB", "3RC", "3RD", "3RE", "3RF", "3RG", "3RH", "3RJ", "3RK", "3RL", "3RM", "3RN", "3RP", "3RR", "3RS", "3RT", "3RU", "3RV", "3RW", "3RX", "3RY", "3SA", "3SB", "3SC", "3SD", "3SE", "3SF", "3SG", "3SH", "3SJ", "3SK", "3SL", "3SM", "3SN", "3SP", "3SR", "3SS", "3ST", "3SU", "3SV", "3SW", "3SX", "3SY", "3TA", "3TB", "3TC", "3TD", "3TE", "3TF", "3TG", "3TH", "3TJ", "3TK", "3TL", "3TM", "3TN", "3TP", "3TR", "3TS", "3TT", "3TU", "3TV", "3TW", "3TX", "3TY", "3UA", "3UB", "3UC", "3UD", "3UE", "3UF", "3UG", "3UH", "3UJ", "3UK", "3UL", "3UM", "3UN", "3UP", "3UR", "3US", "3UT", "3UU", "3UV", "3UW", "3UX", "3UY", "3VA", "3VB", "3VC", "3VD", "3VE", "3VF", "3VG", "3VH", "3VJ", "3VK", "3VL", "3VM"];
const K738 = ["3AA", "3AB", "3AC", "3AD", "3AE", "3AF", "3AG", "3AH", "3AJ", "3AK", "3AL", "3AM", "3AN", "3AP", "3AR", "3AS", "3AT", "3AU", "3AV", "3AW", "3AX", "3AY", "3BA", "3BB", "3BC", "3BD", "3BE", "3BF", "3BG", "3BH", "3BJ", "3BK", "3BL", "3BM", "3BN", "3BP", "3BR", "3BS", "3BT", "3BU", "3BV", "3BW", "3BX", "3BY", "3CA", "3CB", "3CC", "3CD", "3CE", "3CF", "3CG", "3CH", "3CJ", "3CK", "3CL", "3CM", "3CN", "3CP", "3CR", "3CS", "3CT", "3CU", "3CV", "3CW", "3CX", "3CY", "3DA", "3DB", "3DC", "3DD", "3DE", "3DF", "3DG", "3DH", "3DJ", "3DM", "3DN", "3DP", "3DR", "3DS", "3DT", "3DU", "3DV", "3DW", "3DX", "3DY", "3EA", "3EB", "3EC", "3ED", "3EE", "3EF", "3EG", "3EH", "3EJ", "3EK", "3EL", "3EM", "3EN", "3EP", "3ER", "3ES", "3ET", "3EU", "3EV", "3EW", "3EX", "3EY", "3FA", "3FB", "3FC", "3FD", "3FE", "3FF", "3FG", "3FH", "3FJ", "3FK", "3FL", "3FM", "3FN", "3FP", "3FR", "3FS", "3FT", "3FU", "3FV", "3FW", "3FX", "3FY", "3GA", "3GB", "3GC", "3GD", "3GE", "3GF", "3GG", "3GH", "3GJ", "3GK", "3GL", "3GM", "3GN", "3GP", "3GR", "3GS", "3GT", "3GU", "3GV", "3GW", "3GX", "3GY", "3HA", "3HB", "3HC", "3HD", "3HE", "3HF", "3HG", "3HH", "3HJ", "3HK", "3HL", "3HM", "3HN", "3HP", "3HR", "3HS", "3HT", "3HU", "3HV", "3HW", "3HX", "3HY", "3JA", "3JB", "3JC", "3JD", "3JE", "3JF", "3JG", "3JH", "3JJ", "3JK", "3JL", "3JM", "3JN", "3JP", "3JR", "3JS", "3JT", "3JU", "3JV", "3JW", "3JX", "3JY", "3KA", "3KB", "3KC", "3KD", "3KE", "3KF", "3KG", "3KH", "3KJ", "3KK", "3KL", "3KM", "3KN", "3KP", "3KR", "3KS", "3KT", "3KU", "3KV", "3KW", "3KX", "3KY", "3LA", "3LB"];
const R738 = ["3LC", "3LD", "3LE", "3LF", "3LG", "3LH", "3LJ", "3LK", "3LL", "3LM", "3LN", "3LP", "3LR", "3LS", "3LT", "3LU", "3LV", "3LW", "3LX", "3LY", "3MA", "3MB", "3MC", "3MD", "3ME", "3MF", "3MG", "3MH", "3MJ", "3MK", "3ML", "3MM", "3MN", "3MP", "3MR", "3MU", "3MV", "3MW", "3MX", "3MY", "3NA", "3NB", "3NC", "3ND", "3NE", "3NF", "3NG", "3NH", "3NJ", "3NK", "3NL", "3NM", "3NN", "3NP", "3NR", "3NS", "3NT", "3NU", "3NV", "3NW", "3NX", "3NY", "3PA", "3PB", "3PC", "3PD", "3PE", "3PF", "3PG", "3PH", "3PJ", "3PK", "3PL", "3PM", "3PN", "3PP", "3PR", "3PS", "3PT", "3PU", "3PV", "3PW", "3PX"];
const T321 = ["783", "784", "785", "786", "787", "788", "789", "790", "791", "792", "793", "794", "795", "798", "799"];
const S319 = ["001", "002", "003", "004", "005", "006", "007", "008", "009", "010", "011", "012", "013", "014", "015", "016", "017", "018", "019", "020", "021", "022", "023", "024", "025", "026", "027", "028", "029", "030", "031", "032"];
const H319 = ["742", "744", "745", "746", "747", "748", "749", "750", "751", "752", "753", "754", "755", "756", "757", "758", "760", "762", "763", "764", "765", "766", "767", "768", "769", "770", "771", "772", "773", "774", "775", "776", "777", "778", "801", "802", "803", "804", "805", "806", "807", "808", "809", "810", "812", "813", "814", "815", "816", "817", "818", "819", "820", "821", "822", "823", "824", "825", "826", "827", "828", "829", "830", "831", "832", "833", "834", "835", "836", "837", "838", "839", "840"];
const W319 = ["700", "701", "702", "703", "704", "705", "708", "709", "710", "711", "712", "713", "714", "715", "716", "717", "721", "722", "723", "724", "725", "730", "732", "733", "737", "738", "740", "741"];
const A320 = ["102", "103", "104", "105", "107", "108", "109", "110", "111", "112", "114", "117", "118", "119", "121", "122", "123", "124", "125", "126", "127", "128"];
const H205 = ["601", "604", "647", "649", "650", "651", "652", "653", "654", "655", "656", "657", "658", "659", "660", "661", "662", "663", "664", "665", "667", "668", "669", "673", "679", "680"];
const A321 = ["191", "540", "544", "549", "559"];
const E321 = ["400", "401", "402", "403", "404", "405", "406", "407", "408", "409", "410", "411", "412", "413", "414", "415", "416", "417", "418", "419", "420", "421", "422", "423", "424", "425", "426", "427", "428", "429", "430", "431", "432", "433", "434", "435", "436", "437", "438", "439", "440", "441", "442", "443", "444", "445", "446", "447", "448", "449", "450", "451", "452", "453", "454", "455", "456", "457", "458", "459", "460", "461", "462", "463", "464", "465", "466", "467", "468", "469", "470", "471", "472", "473"];
const K321 = ["150", "151", "152", "153", "154", "155", "156", "157", "161", "162", "163", "165", "167", "169", "170", "171", "172", "173", "174", "176", "177", "178", "179", "180", "181", "182", "183", "184", "185", "186", "187", "188", "189", "190", "192", "193", "194", "195", "196", "197", "198", "199", "507", "508", "509", "510", "519", "521", "523", "524", "534", "535", "536", "537", "538", "539", "542", "543", "545", "546", "551", "552", "553", "554", "556", "557", "558", "560", "561", "562", "563", "567", "568", "572", "573", "575", "576", "578", "579", "580", "581", "582", "583", "584", "585", "586", "587", "912", "913", "914", "915", "916", "917", "918", "919", "920", "921", "922", "923", "924", "925", "926", "927", "970", "971", "972", "973", "974", "975", "976", "977", "978", "979", "980", "981", "982"];
const R321 = ["797", "850", "851", "852", "853", "854", "855", "856", "857", "858", "859", "860", "861", "862", "863", "864", "865", "866", "867", "868", "869", "870", "871", "872", "873", "874", "875", "876", "877", "878", "879", "880", "881", "882", "883", "884", "885", "886", "887", "888", "889", "890", "891", "892", "893", "894", "895", "896", "897", "898", "899", "900", "901", "902", "903", "904", "905", "906", "907", "908", "909", "910", "928", "929", "930", "931", "932", "933", "934", "986", "987", "988", "989", "990", "991", "992", "993", "994", "995", "996", "997", "998"];
const N321 = ["950", "951", "952", "953", "954", "955", "956", "957", "958", "959"];
const W773 = ["7LA", "7LB", "7LC", "7LD", "7LE", "7LF", "7LG", "7LH", "7LJ", "7LK", "7LL", "7LM", "7LN", "7LP", "7LR", "7LS", "7LT", "7LU", "7LV", "7LW"];
const B772 = ["7AA", "7AB", "7AC", "7AD", "7AE", "7AF", "7AG", "7AH", "7AJ", "7AK", "7AL", "7AM", "7AN", "7AP", "7AR", "7AS", "7AT", "7AU", "7AV", "7AW", "7AX", "7AY", "7BA", "7BB", "7BC", "7BD", "7BE", "7BF", "7BG", "7BH", "7BJ", "7BK", "7BL", "7BM", "7BN", "7BP", "7BR", "7BS", "7BT", "7BU", "7BV", "7BW", "7BX", "7BY", "7CA", "7CB", "7CC"];
const A332 = ["279", "280", "281", "282", "283", "284", "285", "286", "287", "288", "289", "290", "291", "292", "293"];
const E787 = ["8AA", "8AB", "8AC", "8AD", "8AE", "8AF", "8AG", "8AH", "8AJ", "8AK", "8AL", "8AM", "8AN", "8AP", "8AR", "8AS", "8AT", "8AU", "8AV", "8AW", "8AX", "8AY", "8BA", "8BB", "8BC", "8BD", "8BE", "8BF", "8BG", "8BH", "8BJ", "8BK", "8BL", "8BM", "8BN", "8BP", "8BR"];
const N787 = ["8LA", "8LB", "8LC", "8LD", "8LE", "8LF", "8LG", "8LH", "8LJ", "8LK", "8LL", "8LM", "8LN", "8LP", "8LR", "8LS", "8LT", "8LU", "8LV", "8LW", "8LX", "8LY"];
const P789 = ["8MA", "8MB", "8MC", "8MD"];

const partTimeControlTowers = ["BFL", "BTV", "CHS", "EYW", "GRR", "MAF", "MSO", "MYR", "PSP", "RAP", "RDM", "SJC"];

var flows = {"ABQ":0,"ATL":0,"BZN":0,"DFW":0,"DTW":0,"FCA":0,"IAH":0,"JAC":0,"LAX":0,"MCO":0,"MIA":0,"MSO":0,"PSP":0,"RNO":0,"SAN":0,"SBP":0,"SFO":0,"SJC":0,"SLC":0,"SMF":0,"SNA":0,"TUS":0};

// Toggle Vars
var debug_mode = false;
var mandatory_routes_checked = false;
var input_boxes_shown = false;
var tog_faapref = false;
var tog_cdrroutes = false;

document.getElementById("outbound").addEventListener("keypress", function(event) {
	if (event.key === "Enter") {
		event.preventDefault();
		document.getElementById("go_button").click();
	}
});

$( document ).ready(function() {
	console.log("Remember to set debug_mode! (debug_mode = true;)");
});

function restore_last() {
	$("#outbound").val($("#ob_copy").val());
	compute();
}

function toggle_mandatory_routes() {
	mandatory_routes_checked = !mandatory_routes_checked;
	restore_last();
}
function toggle_input_boxes() {
	input_boxes_shown = !input_boxes_shown;
	$("#input_boxes").toggle();
	$("#button_toggle_input_boxes").text(((input_boxes_shown) ? 'Hide Input Boxes' : 'Show Input Boxes'));
}
function toggle_faa_pref() {
	tog_faapref = !tog_faapref;
	var today = new Date();
	$("#button_faapref_default").text(((tog_faapref) ? 'No FAA pref' : 'Remove Pref Rte Comments'));
	$("#input_faapref_default").val(((tog_faapref) ? '' : '// ') + 'result += \"<br/><br/><b>Faa Pref Route:</b>\";' + ((tog_faapref) ? '' :  ' // No FAA Pref route as of ' + 
		String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0') + "-" + String(today.getFullYear())));
}
function toggle_cdr_routes() {
	tog_cdrroutes = !tog_cdrroutes;
	var today = new Date();
	$("#button_cdrroutes_default").text(((tog_cdrroutes) ? 'No CDRs listed' : 'Remove CDR Comments'));
	$("#input_cdrroutes_default").val(((tog_cdrroutes) ? '' : '// ') + 'result += \"<br/><br/><b>CDRS</b>\";' + ((tog_cdrroutes) ? '' : ' // No CDRs as of ' +
		String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0') + "-" + String(today.getFullYear())));
}

function update_cdr_text(input_id = null, coord_req = -1) {
	// input id = CDR name
	var result = "Unable to process route string // No changes made. Input_ID = \"" + input_id + "\", coord_req = \"" + coord_req + "\"";
	if (input_id != null) {
		var coord_req_text = ((coord_req == 1) ? "<span style=\\\"color:red\\\"> (Coord Req)</span>: " : "<span style=\\\"color:green\\\"> (Ok to File)</span>: ");
		$("#cdrdescbr_" + input_id).val("</br>" + $("#cdrdesc_" + input_id).val());
		if (coord_req == -1) { coord_req_text = ""; }
		result = "result += \"<br/>" + ($("#cdrdesc_" + input_id).val()) + coord_req_text + "<input style=\\\"width:75%\\\" value=\\\"" + ($("#cdrstr_" + input_id).val()) + "\\\" readonly>\"; \/\/ CDR " + input_id;
		$("#cdrcp_" + input_id).val(result);
	}
	return result;
	// Route Str = cdrstr_xxx || Description = cdrdesc_xxx || CopyPaste = cdrcp_xxx
}
function update_rte_text() {
	$("#newroute_oktofile").val('result += \"<br/>' + $('#3box_desc').val() + '<span style=\\\"color:green\\\"> (Ok to File)<\/span>: <input style=\\\"width:75%\\\" value=\\\"' + $('#3box_route').val() + '\\\" readonly>\";');
	$("#newroute_coordreq").val('result += \"<br/>' + $('#3box_desc').val() + '<span style=\\\"color:red\\\"> (Coord Req)<\/span>: <input style=\\\"width:75%\\\" value=\\\"' + $('#3box_route').val() + '\\\" readonly>\";');
	$("#newroute_xxx").val('result += \"<br/>' + $('#3box_desc').val() + ': <input style=\\\"width:75%\\\" value=\\\"' + $('#3box_route').val() + '\\\" readonly>\";');
	$('#3box_desc2').val('<br\/>' + $('#3box_desc').val());
}

function compute (str_override = "") {
	var output = "Check the input box and make sure you pasted the right thing.";
	var reg;
	var narrow_ci_min = 10;
	var narrow_ci_max = 80;
	var wide_ci_min = 40;
	var wide_ci_max = 300;
	var exc_regex = /\n\!\n/g;
	var fkeystxt = ((str_override != 0 && str_override.trim().length > 0) ? str_override : $("#outbound").val());
	var routes_arr = {'faa_pref' : null, 'non_rnav' : null, 'cdrs' : {} };
	var mr_text = ((mandatory_routes_checked) ? " // Mandatory Routes checked" : "");

	if ($("#outbound").val() == "debug") { debug_mode = !debug_mode; output = "Debug mode: " + (debug_mode ? "ON" : "OFF"); }
	
	$("#ob_copy").val($("#outbound").val());
	$("#total").html("");
	rega = /TOW\n(\d+)\n(\d+)\n([^\n]*)\nLDW\n(\d+)\n(\d+)\n/g;
	regb = /light\n\n([A-Z]{4})\n+[^\n]+\n[^\n]+\n\n[^\n]+\n\n([A-Z]{4})[\s\S]+AA[LT]([\dA-Z]+)\n\!\nC I\:[^\(]+\([^\s]+\s([^\,\n\.]+)[\,\n\.][^\n]*\n[\s\S]+\)\n([A-Za-z0-9]{3})\nMEL/g;

	// ATCSCC CDRS
	// https://www.fly.faa.gov/rmt/cdm_operational_coded_departur.jsp
	regc = /\d\t([^\t]{8})\t([A-Z]{4})\t([A-Z]{4})\t[^\t]*\t([^\t]+)\t[^\t]*\t[^\t]*\t[^\t]*\t([YN])\t(\d)\t/g;

	// Decs route page
	regz = /[DI][\d]+\s+\d+\s[A-Z]\s[A-Z]\s[A-Z][^\n]+\n\s*ARTC TEXT/g;

	// Airway
	regy = /\<(\d+)\s\<(K\d)\s\<([^\s]+)\s/g;

	// VAA App
	regw = /(PERMANENT AIRPORT ANALYSIS)/g;

	// Briefing
	regv = /PAGE\s[^\n]+([A-Z]{4})\-([A-Z]{4})\sAAL([^\n]+)\n[\s\S]+682\-315\-\d{2}(\d{2})[\s\S]+PLAN\sARR\sFUEL\s(\d+)\s(\d+)\n\-+\n([\s\S]+)ON TIME ANALYSIS\n\-+\n/g;

	// All CDRs doc // FAA download
	regu = /RCode\tOrig\tDest\tDepFix\tRoute String\tDCNTR\tACNTR\tTCNTRs\tCoordReq\tPlay\tNavEqp/g;
	
	var testing = false;
	var land_wgt_limited = false;
	var parse_ab = (((result = rega.exec(fkeystxt)) != null) || ((result = regb.exec(fkeystxt)) != null));

	// For Testing Station Info
	// XXXYYY | x = dptr | y = arr
	// xxx - YYY | x = dptr | y = arr
	if (fkeystxt.replaceAll(" ","").replaceAll("-","").length == 6) {
		fkeystxt = fkeystxt.replaceAll("-","").replaceAll(" ","");
		testing = true;
		parse_ab = true;
	}

	tmp_rslt = regb.exec(fkeystxt);

	if ((result = regz.exec(fkeystxt)) != null) {
		output = decs_route(fkeystxt, routes_arr['cdr_list']);
	} else if ((result = regc.exec(fkeystxt)) != null) {
		// TODO get array from compute first
		
		// ATSCC CDR page ONLY
		output = cdr_parse(fkeystxt);
	} else if ((result = regw.exec(fkeystxt)) != null) {
		output = vaa_parse(fkeystxt);
	} else if ((result = regv.exec(fkeystxt)) != null) {
		output = briefing_parse(fkeystxt);
	} else if ((result = regu.exec(fkeystxt)) != null) {
		output = cdrdoc_parse(fkeystxt, true);
	} else if (testing || ((result = rega.exec(fkeystxt)) != null)) {
		var mlwa = 7777;
		var mlwb = 7777;
		parse_found = true;
		if (!testing) {
			mlwa = parseInt(result[2]) - parseInt(result[1]); // Takeoff weight buffer
			mlwb = parseInt(result[5]) - parseInt(result[4]); // Landing weight buffer
			land_wgt_limited = ((mlwa < mlwb) ? false : true);
			if (result[3] == "E") { // Using Method 1
				mlwa = mlwb;
			}
		}

		// Get ac_type
		var ac_type = (testing ? "321R" : get_ac_type(tmp_rslt[5]));

		output = "MTOW SPREAD: ";
		var reg_ci = /C\sI\:(\d+)[^\d]/g;
		if (mlwa < mlwb) {
			output += '<span style="color:';
			if (mlwa <= 2000) {
				output += 'red';
			} else if (mlwa <= 5000) {
				output += 'orange';
			} else {
				output += 'green';
			}
			output += '"><b>' + ((mlwa > 9999) ? "10K+" : mlwa) + "</b></span>";
			if (mlwa <= 5000) {
				output += "&nbsp;&nbsp;&nbsp;<b>Takeoff Wgt Rstr</b>";
				if ((ci_res = reg_ci.exec(fkeystxt)) != null) {
					var ci_int = parseInt(ci_res);
					
					/*
					console.log(ci_int);
					console.log(parseInt(ci_res));
					*/
					
					if (["319S", "H319", "319W", "A320", "H205", "738M", "738K", "738R", "321T", "A321", "321E", "321K", "321R", "321N"].includes(ac_type)) {
						// Narrow Body
						if (ci_int > 20) {
							output += "<br/><b style='color:yellow'>CI is " + ci_int + " - consider lowering to increase MTOW spread (min " + narrow_ci_min + ")</b>";
						}
					} else if (["B772", "773W", "7878", "7879", "789P"].includes(ac_type)) {
						// Wide Body
						if (ci_int > 50) {
							output += "<br/><b style='color:yellow'>CI is " + ci_int + " - consider lowering to increase MTOW spread (min " + wide_ci_min + ")</b>";
						}
					}
				}
			}
		} else {
			output += '<span style="color:';
			if (mlwb <= 2000) {
				output += 'red';
			} else if (mlwb <= 5000) {
				output += 'orange';
			} else {
				output += 'green';
			}
			output += '"><b>' + ((mlwb > 9999) ? "10K+" : mlwb) + "</b></span>";
			if (mlwb <= 5000) {
				 output += "&nbsp;&nbsp;&nbsp;<b>Land Wgt Rstr</b>";
				if ((ci_res = reg_ci.exec(fkeystxt)) != null) {
					var ci_int = parseInt(ci_res);

					/*
					console.log(ci_int);
					console.log(parseInt(ci_res));
					*/

					if (["319S", "H319", "319W", "A320", "H205", "738M", "738K", "738R", "321T", "A321", "321E", "321K", "321R", "321N"].includes(ac_type)) {
						// Narrow Body
						if (ci_int > 20) {
							output += "<br/><b style='color:yellow'>CI is " + ci_int + " - consider lowering to increase MTOW spread (min " + narrow_ci_min + ")</b>";
						}
					} else if (["B772", "773W", "7878", "7879", "789P"].includes(ac_type)) {
						// Wide Body
						if (ci_int > 50) {
							output += "<br/><b style='color:yellow'>CI is " + ci_int + " - consider lowering to increase MTOW spread (min " + wide_ci_min + ")</b>";
						}
					}
				}
			}
			if (!testing && result[3] == "E" && !land_wgt_limited) {
				output += "&nbsp;&nbsp;&nbsp;<b style='color:orange'>Method 1 in use</b>";
			}
		}
		if (["321T", "A321", "321K", "321R", "321N"].includes(ac_type)) { // 321E (Neos) are ok
			reg_fob = /TOTAL[^\d]*(\d+)[^\d]/g;
			var unnecessary_var = reg_fob.exec(fkeystxt);
			if (unnecessary_var && parseInt(unnecessary_var[1]) > 47000) {
				output += "<br/><b style='color:" + ((parseInt(unnecessary_var[1]) > 49000) ? "red" : "orange") + "'>A321 balance issues when FOB above 47000 lbs (Cur FOB " + parseInt(unnecessary_var[1]) + " - Coordinate with loads)</b>";
			}
		}
	} else if (debug_mode) {
		console.log("regb parse error");
	}
	if (testing || (tmp_rslt != null)) {
		/*
	 	*	1 - Dptr Station
	 	*	2 - Arvl Station
	   	*	3 - Flt Number
		* 	4 - Captain
	   	*	5 - Tail Number
		*/
		if (testing) {
			result = [null,
				fkeystxt.substring(0, 3).toUpperCase(),
				fkeystxt.substring(3, 6).toUpperCase(),
				7777,
				"TESTING",
				"850"
			];
		} else {
			result = tmp_rslt;
		}

		var tmpres = result[3] + '&nbsp;&nbsp;&nbsp;' + result[1] + '&nbsp;&nbsp;&nbsp;' + result[5] + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + result[4];
		output = tmpres + '<br/>' + output;

		// Approach Category
		output += "<br/>" + ac_type + "&nbsp;&nbsp;&nbsp;CAT ";
		if (["319S", "H319", "319W", "A320", "H205", "B772"].includes(ac_type)) {
			// Cat C
			output += "C"; // 121-141 Kts
		} else if (["738M", "738K", "738R", "321T", "A321", "321E", "321K", "321R", "321N", "773W", "7878", "7879", "789P"].includes(ac_type)) {
			if (ac_type == "738R") {
				// SFP - Cat C under certain conditions
				output += "C [flaps 40 straight-in] // Cat D [circle-to-land]";
			} else {
				// Cat D
				output += "D"; // 141-165 Kts
			}
		} else { output += "Unknown"; }
		// Cost Index
		output += ((ac_type == "738R") ? "<br/>" : "&nbsp;&nbsp;||&nbsp;") + "&nbsp;ci: ";
		if (["319S", "H319", "319W", "A320", "H205", "738M", "738K", "738R", "321T", "A321", "321E", "321K", "321R", "321N"].includes(ac_type)) {
			// Narrow Body
			output += narrow_ci_min + " - " + narrow_ci_max + " (lower/slower/lighter)";
		} else if (["B772", "773W", "7878", "7879", "789P"].includes(ac_type)) {
			// Wide Body
			output += wide_ci_min + " - " + wide_ci_max + " (lower/slower/lighter)";
		} else { output += "Unknown"; }

		// Non-scheduled flight
		if (result[3] > 8999 && result[3] < 10000) {
			// Reminder to amend flight type if non-scheduled
			output += "<br/><b style='color:orange'>Change flight type in ATC filing for all non-scheduled flights (Click envelope, flight type dropdown -> 'N')</b>";
			if (result[1] == "KDCA" || result[2] == "KDCA") {
				// Reminder to contact TSA for unscheduled DCA flights
				output += "<br/><b style='color:red'>DCA TSA must be contacted at least one hour prior to departure for non-scheduled operations (DPM 5.6.1)</b>";
			}
		}

		// Airport Specific
		output = airport_extra(flows, result[1], result[2], result[5], ac_type, output);
	} else if (debug_mode && parse_ab) {
		console.log("flifo parse error");
	}

	// Tanker | Ferry Fuel
	regc = /(\d+)\t\d+\:\d+\tH\n+TOTAL/g;
	if ((tmpres = regc.exec(fkeystxt)) != null) {
		output += "<br/>Ferry Fuel: <b>" + tmpres[1] + "</b>";
	}

	// Routes
	if (regz.exec(fkeystxt) == null && (testing || parse_ab)) {
		output = get_routes(result[1], result[2], result[5], ac_type, output);
		$("#outbound").val("");
		if (debug_mode) {
			var today = new Date();
			var tmp_today_str = String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0') + "-" + String(today.getFullYear());
			regad = /\<\!\-\-\sUpdated\s([\d\-]+)\s([A-Z]*)\s*\-\-\>/g;
			if ((tmp_xad = regad.exec(output)) !== null) {
				$("#outbound").val(("Updated " + tmp_xad[1] + "\n" + tmp_xad[2]).trim());
			}
			var tmp_textarea_tabs = ((["CLT","DFW","LAX","MIA","ORD","PHX"].includes(((result[1].length > 3) ? convert_iata(result[1]) : result[1]))) ? "\n\t\t\t" : "\n\t\t\t\t\t");
			output += '<br/><br/><button id=\"button_toggle_input_boxes\" onclick=\"toggle_input_boxes()\">' + (input_boxes_shown ? 'Hide' : 'Show') + ' Input Boxes</button>';
			output += '<div id="input_boxes">';

			// Faa Pref
			output += '<br/><hr><br/><input id=\'input_faapref_default\' style=\'width:75%\' value=\'' + ((tog_faapref) ? '' : '// ') + 'result += \"<br/><br/><b>Faa Pref Route:</b>\";' + ((tog_faapref) ? '' :  ' // No FAA Pref route as of ' + tmp_today_str) + '\' readonly>';
			output += '&nbsp;&nbsp;<button id=\'button_faapref_default\' onclick=\"toggle_faa_pref()\">' + ((tog_faapref) ? 'No FAA pref' : 'Remove Pref Rte Comments') + '</button>';

			// CDRs
			output += '<br/><input id=\'input_cdrroutes_default\' style=\'width:75%\' value=\'' + ((tog_cdrroutes) ? '' : '// ') + 'result += \"<br/><br/><b>CDRS</b>\";' + ((tog_cdrroutes) ? '' : ' // No CDRs as of ' + tmp_today_str) + '\' readonly>';
			output += '&nbsp;&nbsp;<button id=\'button_cdrroutes_default\' onclick=\"toggle_cdr_routes()\">' + ((tog_cdrroutes) ? 'No CDRs listed' : 'Remove CDR Comments') + '</button>';

			// 3 input boxes: [green, red, xxx]
			output += '<hr>Route: <input id=\'3box_route\' style=\'width:25%\' value=\'YYY\' onchange=\'update_rte_text()\'>';
			output += '&nbsp;&nbsp;&nbsp;&nbsp;Desc: <input id=\'3box_desc\' style=\'width:25%\' value=\'XXX\' onchange=\'update_rte_text()\'>';
			output += '&nbsp;&nbsp;&nbsp;&nbsp;Desc BR: <input id=\'3box_desc2\' style=\'width:25%\' value=\'<br\/>XXX\' readonly>';
			output += '<br/><span style=\"color:green\"> (Ok to File)</span>: <input id=\'newroute_oktofile\' style=\'width:75%\' value=\'' +
				'result += \"<br/>XXX<span style=\\\"color:green\\\"> (Ok to File)<\/span>: <input style=\\\"width:75%\\\" value=\\\"YYY\\\" readonly>\";' +
				'\' readonly>';
			output += '<br/><span style=\"color:red\"> (Coord Req)</span>: <input id=\'newroute_coordreq\' style=\'width:75%\' value=\'' +
				'result += \"<br/>XXX<span style=\\\"color:red\\\"> (Coord Req)<\/span>: <input style=\\\"width:75%\\\" value=\\\"YYY\\\" readonly>\";' +
				'\' readonly>';
			output += '<br/>XXX: <input id=\'newroute_xxx\' style=\'width:75%\' value=\'' +
				'result += \"<br/><input style=\\\"width:75%\\\" value=\\\"YYY\\\" readonly>\";' +
				'\' readonly>';

			// Bottom text box
			// output += '<br/><br/><input style=\'width:75%\' value=\'case "' + convert_iata(result[2]) + '": // Updated ' + tmp_today_str + mr_text + '\' readonly>';
			// output += '<br/><input style=\'width:75%\' value=\'result += \"<!-- Updated ' + tmp_today_str + (mandatory_routes_checked ? " M" : " ") + 'P -->\";\' readonly>';
			output += '<hr><textarea rows="8" cols="80"> // Updated ' + tmp_today_str + mr_text + tmp_textarea_tabs +
				'result += "<!-- Updated ' + tmp_today_str + (mandatory_routes_checked ? " M" : " ") + 'P -->";</textarea>';
				// + tmp_textarea_tabs + 'result += "<br/><br/><b>Faa Pref Route:</b>";</textarea>';
			output += '<br/><button onclick=\"toggle_mandatory_routes()\">Turn ' + (mandatory_routes_checked ? "OFF" : "ON") + ' Mandatory Routes</button>';
			output += '</div>';
		}
	}

	$("#total").html('<br/>' + output);
	if (parse_ab && result != null) {
		change_flow(((result[1].length == 4) ? (result[1].substr(1, 4)) : result[1]), flows[((result[1].length == 4) ? (result[1].substr(1, 4)) : result[1])], true);
		change_flow(((result[2].length == 4) ? (result[2].substr(1, 4)) : result[2]), flows[((result[2].length == 4) ? (result[2].substr(1, 4)) : result[2])], true);
	}
	if (!input_boxes_shown) { $("#input_boxes").hide(); }
}

function cdr_parse(input = null, to_array = false, result_arr = {'faa_pref' : {}, 'non_rnav' : {}, 'cdrs' : {}}) {
	if (input == null) { return ""; }
	var today = new Date();
	var today_str = String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0') + "-" + String(today.getFullYear());
	var today_str_short = String(today.getMonth() + 1) + "/" + String(today.getDate()) + "/" + String(today.getYear()-100);
	var reg_tmp = /\d\t[A-Z]{6}([^\t]{2})\t([A-Z]{4})\t([A-Z]{4})\t[^\t]*\t([^\t]+)\t[^\t]*\t[^\t]*\t[^\t]*\t([YN])\t(\d)\t([^\n]*)\n/g;
	var dptr = "KXXX";
	var arvl = "YYY";
	var faa_pref = "";
	var non_rnav = "";
	var non_rnav_coordreq = true;
	var cdr_str = "";
	var playbooks = {};
	var mr_text = ((mandatory_routes_checked) ? " // Mandatory Routes checked" : "");
	while(null != (z = reg_tmp.exec(input))) {
		dptr = z[2].substring(0, 4);
		arvl = z[3].substring(1, 4);
		var textarea_tabs = ((["KCLT","KDFW","KLAX","KMIA","KORD","KPHX"].includes(dptr)) ? "\n\t\t\t" : "\n\t\t\t\t\t");
		var file_status = "<span style=\\\"color:" + ((z[5] == "Y") ? "red\\\"> (Coord Req)" : "green\\\"> (Ok to File)") + "<\/span>";

		// FAA Pref
		if (dptr == "KCLT" && z[1] == "RP") { // CLT
			faa_pref = "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR RP";
			result_arr['faa_pref'] = {'route' : z[4], 'notes' : 'CDR RP', 'avg_fl' : null, 'result_str' : "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR RP"};
		} else if (dptr == "KDCA" && z[1] == "00") { // DCA
			faa_pref = "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR 00";
			result_arr['faa_pref'] = {'route' : z[4], 'notes' : 'CDR 00', 'avg_fl' : null, 'result_str' : "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR 00"};
		} else if (dptr == "KDFW" && z[1] == "0P") { // DFW
			faa_pref = "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR 0P";
			result_arr['faa_pref'] = {'route' : z[4], 'notes' : 'CDR 0P', 'avg_fl' : null, 'result_str' : "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR 0P"};
		} else if (dptr == "KPHL" && z[1] == "PH") { // PHL
			faa_pref = "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR PH";
			result_arr['faa_pref'] = {'route' : z[4], 'notes' : 'CDR PH', 'avg_fl' : null, 'result_str' : "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR PH"};
		}

		// Playbook
		z[7] = z[7].trim();
		if (z[7].length > 0) {
			playbooks[z[7]] = {'route' : z[4], 'desc' : z[7], 'coord_req' : ((z[5] == "N") ? false : true),
						 'result_str' : ("result += \"<br/>" + z[7] + file_status + ": <input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\";") };
		}

		// Non Rnav
		if (z[6] == 1 && (non_rnav.length == 0 || (non_rnav_coordreq && z[5] == "N"))) {
			non_rnav_coordreq = ((z[5] == "Y") ? true : false);
			non_rnav = "result += \"<br/><input style=\\\"width:75%\\\"; value=\\\"" + z[4] + "\\\"; readonly>\"; \/\/ CDR " + z[1];
			if (result_arr['non_rnav'] == null) {
				result_arr['non_rnav'] = {'route' : z[4], 'coord_req' : non_rnav_coordreq, 'notes' : ("CDR " + z[1]), 'result_str' : ("result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR " + z[1]) };
			}
		}

		// CDRs
		cdr_str += textarea_tabs + "result += \"<br/>" + z[1] + file_status + ": <input class=\\\"cdr_input\\\" style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\";";
		result_arr['cdrs'][z[1]] = {'route' : z[4], 'notes' : ("CDR " + z[1]), 'verified' : today_str, 'result_str' : ("result += \"<br/>" + z[1] + file_status + ": <input class=\\\"cdr_input\\\" style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\";") };
	}

	// Sort Playbooks
	var sortable = [];
 	for (var key in playbooks) {
		// playbook, route, coord_req, result_str
		sortable.push([playbooks[key]['desc'], playbooks[key]['route'], playbooks[key]['coord_req'], playbooks[key]['result_str']]);
	}
	if (sortable.length > 1) {
		sortable.sort(function(x, y) {
			// playbook, route, coord_req, result_str
			//  0         1        2         3
			return (x[0].localeCompare(y[0]));
		});
	}
	/* Add extra <br> at the beginning; function now obsolete
	if (sortable.length > 0) {
		sortable[0][3] = sortable[0][3].replace('result += \"<br/>', 'result += \"<br/><br/>');
	}
	*/
	result_arr['other'] = sortable;

	result_arr['arvl'] = ((arvl.length == 4) ? arvl.substring(1, 4) : arvl);
	result_arr['dptr'] = ((dptr.length == 4) ? dptr.substring(1, 4) : dptr);

	var playbook_str = "";
	for (var i = 0; i < sortable.length; i++) {
		playbook_str += sortable[i][3] + textarea_tabs;
	}

// console.log(cdr_str);
	
	var new_cdr_str = "";
	reg_tmp_cdrstr = /result\s\+\=\s\"\<br\/\>([^\<]+)(\<span\sstyle[^\>]+\>\s\([^\)]+\)\<\/span\>)\:\s\<[^\>]+\s(value\=\\\"[^\"]+\")\sreadonly/g;	
	while(null != (z = reg_tmp_cdrstr.exec(cdr_str))) {

		// z[1] = CDR name
		// z[2] = Coord Rqd -or- OK to file
		// z[3] = route string as input value

		// Route Str = cdrstr_xxx || Description = cdrdesc_xxx || CopyPaste = cdrcp_xxx
		new_cdr_str += "<br/>CDR " + z[1] + z[2].replaceAll("\\", "") + ": <input id=\"cdrstr_" + z[1] + "\" class=\"cdr_input\" style=\"width:50%\" " + z[3].replaceAll("\\", "") + " readonly>";
		if (debug_mode) {
			new_cdr_str += "&nbsp;&nbsp;Desc: <input id=\"cdrdesc_" + z[1] + "\" style=\"width:10%\" value=\"XXX\" onchange=\"update_cdr_text('" + z[1] + "'," + ((z[2].includes("Coord Req")) ? 'true' : 'false') + ")\" } />" +
			"&nbsp;&nbsp;<input id=\"cdrdescbr_" + z[1] + "\" style=\"width:10%\" value=\"<br/>XXX\" readonly><br/>" +
			z[1] +": <input id=\'cdrcp_" + z[1] + "\' style=\'width:75%\' value=\'" +
			"result += \"<br/>XXX" + ((z[2].includes("Coord Req")) ? "<span style=\\\"color:red\\\"> (Coord Req)</span>: " : "<span style=\\\"color:green\\\"> (Ok to File)</span>: ") + 
			"<input style=\\\"width:75%\\\" " + z[3] + " readonly>\"; \/\/ CDR " + z[1] + "\' readonly><br/>";
		}
	}

	// Add SIDS BFL
	new_cdr_str = new_cdr_str.replaceAll("KBFL EHF", "KBFL MARIC4 EHF");
	new_cdr_str = new_cdr_str.replaceAll("KBFL PMD", "KBFL MARIC4 LHS PMD");
	// Add SIDS BUR
	new_cdr_str = new_cdr_str.replaceAll("KBUR BLH", "KBUR SLAPP2 BLH");
	new_cdr_str = new_cdr_str.replaceAll("KBUR CSTRO", "KBUR OROSZ2 CSTRO");
	new_cdr_str = new_cdr_str.replaceAll("KBUR DVC", "KBUR SLAPP2 LAS J146 DVC");
	new_cdr_str = new_cdr_str.replaceAll("KBUR HEC", "KBUR SLAPP2 HEC");
	new_cdr_str = new_cdr_str.replaceAll("KBUR LAS", "KBUR SLAPP2 LAS");
	new_cdr_str = new_cdr_str.replaceAll("KBUR PMD TRM BLH", "KBUR SLAPP2 BLH");
	new_cdr_str = new_cdr_str.replaceAll("KBUR PMD TRM", "KBUR VNY3 VNY TRM");
	new_cdr_str = new_cdr_str.replaceAll("KBUR TRM", "KBUR VNY3 VNY TRM");
	new_cdr_str = new_cdr_str.replaceAll("KBUR PMD", "KBUR VNY3 PMD");
	// Add SIDS LAS
	new_cdr_str = new_cdr_str.replaceAll("KLAS GUP", "KLAS NIITZ4 SSKEE GUP");
	new_cdr_str = new_cdr_str.replaceAll("KLAS INW", "KLAS NIITZ4 SSKEE INW");
	new_cdr_str = new_cdr_str.replaceAll("KLAS TBC", "KLAS NIITZ4 HOCEE TBC");
	new_cdr_str = new_cdr_str.replaceAll("KLAS DVC", "KLAS GIDGT3 TUKRR DVC");
	new_cdr_str = new_cdr_str.replaceAll("KLAS PGS",   "KLAS HOOVR8 PGS");
	new_cdr_str = new_cdr_str.replaceAll("KLAS VERKN", "KLAS GIDGT3 VERKN");
	new_cdr_str = new_cdr_str.replaceAll("KLAS TUKRR", "KLAS GIDGT3 TUKRR");
	new_cdr_str = new_cdr_str.replaceAll("KLAS SSKEE", "KLAS NIITZ4 SSKEE");
	new_cdr_str = new_cdr_str.replaceAll("KLAS SSKEE", "KLAS NIITZ4 HOCEE");
	new_cdr_str = new_cdr_str.replaceAll("KLAS ZAYNE", "KLAS RASLR3 ZAYNE");
	new_cdr_str = new_cdr_str.replaceAll("KLAS FRNCK", "KLAS RATPK3 FRNCK");
	new_cdr_str = new_cdr_str.replaceAll("KLAS JAYSN", "KLAS LOHLA3 JAYSN");
	new_cdr_str = new_cdr_str.replaceAll("KLAS KENNO", "KLAS JOHKR5 KENNO");
	new_cdr_str = new_cdr_str.replaceAll("KLAS LVELL", "KLAS RADYR2 LVELL");
	new_cdr_str = new_cdr_str.replaceAll("KLAS HEC",   "KLAS RADYR2 HEC");
	// Add SIDS LAX
	new_cdr_str = new_cdr_str.replaceAll("KLAX LAS", "KLAX ORCKA5 LAS");
	new_cdr_str = new_cdr_str.replaceAll("KLAX BEALE", "KLAX ORCKA5 BEALE");
	new_cdr_str = new_cdr_str.replaceAll("KLAX CLEEE", "KLAX DOTSS2 CLEEE");
	new_cdr_str = new_cdr_str.replaceAll("KLAX CNERY", "KLAX DOTSS2 CNERY");
	// new_cdr_str = new_cdr_str.replaceAll("KLAX BLH", "KLAX BLH"); // todo non rnav qqq
	new_cdr_str = new_cdr_str.replaceAll("KLAX TCATE", "KLAX PNDAH2 TCATE");
	new_cdr_str = new_cdr_str.replaceAll("KLAX FICKY", "KLAX ZILLI5 FICKY");
	// Add SIDS ONT
	new_cdr_str = new_cdr_str.replaceAll("KONT BLH", "KONT RAJEE4 MTBAL CNERY BLH");
	new_cdr_str = new_cdr_str.replaceAll("KONT DVC", "KONT SNSHN5 LAS J146 DVC");
	new_cdr_str = new_cdr_str.replaceAll("KONT EHF", "KONT SNSHN5 EHF");
	new_cdr_str = new_cdr_str.replaceAll("KONT LAS", "KONT SNSHN5 LAS");
	new_cdr_str = new_cdr_str.replaceAll("KONT AVRRY", "KONT RAJEE4 AVRRY");
	new_cdr_str = new_cdr_str.replaceAll("KONT MTBAL", "KONT RAJEE4 MTBAL");
	// Add SIDS PSP
	new_cdr_str = new_cdr_str.replaceAll("KPSP BLH", "KPSP HWRRD1 BLH");
	new_cdr_str = new_cdr_str.replaceAll("KPSP PMD", "KPSP LGANN1 PMD");
	new_cdr_str = new_cdr_str.replaceAll("KPSP PSP", "KPSP CATH1 PSP");
	new_cdr_str = new_cdr_str.replaceAll("KPSP TNP", "KPSP CATH1 PSP V370 TNP");
	new_cdr_str = new_cdr_str.replaceAll("KPSP TRM", "KPSP HWRRD1 TRM");
	// Add SIDS SAN
	new_cdr_str = new_cdr_str.replaceAll("KSAN FTI", "KSAN TGOLD PXR J18 FTI");
	new_cdr_str = new_cdr_str.replaceAll("KSAN GBN", "KSAN ZZOOO4 GBN");
	new_cdr_str = new_cdr_str.replaceAll("KSAN IKAYE", "KSAN PADRZ2 IKAYE");
	new_cdr_str = new_cdr_str.replaceAll("KSAN LAX EHF", "KSAN PADRZ7 EHF");
	new_cdr_str = new_cdr_str.replaceAll("KSAN MTBAL", "KSAN ZZOOO4 MTBAL");
	new_cdr_str = new_cdr_str.replaceAll("KSAN TGOLD", "KSAN ZZOOO4 TGOLD");
	// Add SIDS SBA // TODO
	// new_cdr_str = new_cdr_str.replaceAll("KSBA KPTIN", "KSBA  KPTIN");
	// new_cdr_str = new_cdr_str.replaceAll("KSBA LAS", "KSBA  LAS");
	// new_cdr_str = new_cdr_str.replaceAll("KSBA PMD", "KSBA  PMD");
	// Add SIDS SBP // TODO
	// new_cdr_str = new_cdr_str.replaceAll("KSBP LAS", "KSBP  LAS");
	// new_cdr_str = new_cdr_str.replaceAll("KSBP PMD", "KSBP  PMD");
	// Add SIDS SNA
	new_cdr_str = new_cdr_str.replaceAll("KSNA AVRRY", "KSNA PIGGN3 AVRRY");
	new_cdr_str = new_cdr_str.replaceAll("KSNA BEALE", "KSNA FINZZ3 BEALE");
	new_cdr_str = new_cdr_str.replaceAll("KSNA BLH", "KSNA PIGGN3 CNERY BLH");
	new_cdr_str = new_cdr_str.replaceAll("KSNA CNERY", "KSNA PIGGN3 CNERY");
	new_cdr_str = new_cdr_str.replaceAll("KSNA TCATE", "KSNA PIGGN3 TCATE");
	new_cdr_str = new_cdr_str.replaceAll("KSNA DVC", "KSNA FINZZ3 LAS J146 DVC");
	new_cdr_str = new_cdr_str.replaceAll("KSNA EHF", "KSNA HHERO3 EHF");
	new_cdr_str = new_cdr_str.replaceAll("KSNA LAS", "KSNA FINZZ3 LAS");

	var faa_result = merge_faa_pref(result_arr, today_str);

	// -- HTML Building below here --
	// Errors
	var output = '<b style=\'color:red\'>' + faa_result['errors'] + '<\/b>' +
				'<span style=\'color:orange\'>' + faa_result['warnings']  + '<\/span><br/><br/>';
	// First input line
	output += '<input style=\'width:75%\' value=\'// result += \"<br/><br/><b>Faa Pref Route:</b>\"; // No FAA pref route as of ' + 
		today_str + '\' readonly><br/><br/>';

	// Top large box
	output += '<textarea rows="8" cols="80">' + "case \"" + arvl + "\":" + ' // Updated ' + today_str + mr_text + textarea_tabs +
		'result += \"<!-- Updated ' + today_str + ' P -->\";' + textarea_tabs +
		'result += \"<br/><br/><b>Faa Pref Route:</b>\";' + textarea_tabs + faa_pref + textarea_tabs + 
		((non_rnav.length == 0) ? "// " : "") + 'result += \"<br/><br/><b>Non RNAV</b>\";' +
		((non_rnav.length == 0) ? " // TODDO" : (textarea_tabs + non_rnav)) +
		'</textarea><br/><br/>' +
		((playbook_str.length > 0) ? ('<textarea rows="8" cols="80">result += \"<br/><br/><b>Playbooks:</b>\";' + textarea_tabs + playbook_str.trim().replace("<br/><br/>","<br/>") + '</textarea><br/><br/>') : "") +
		'<textarea rows="15" cols="80">' + 'result += \"<br/><br/><b>CDRS</b>\"; \/\/ Verified with ATCSCC on ' + today_str + textarea_tabs +
		'result += \"<!-- Verified with ATCSCC on ' + today_str + ' -->\";' +
		cdr_str + textarea_tabs + "break;</textarea><br/><br/>" + new_cdr_str +
		'<br/><br/><button onclick=\"clear_input(0)\">Clear</button>';
	if (to_array) { return result_arr; }
	return output;
}

function merge_faa_pref(result_arr = {}) {
	var textarea_tabs = ((["CLT","DFW","LAX","MIA","ORD","PHX","KCLT","KDFW","KLAX","KMIA","KORD","KPHX"].includes(dptr)) ? "\n\t\t\t" : "\n\t\t\t\t\t");
	var errors = "";
	var warnings = "";
	var status = "";
	if (today_str == null || today_str.trim().length == 0) {
		var today = new Date();
		var today_str = String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0') + "-" + today.getFullYear();
	}
	var result = "";
	var dptr = result_arr['dptr'];
	var arvl = result_arr['arvl'];

	// FAA PREF
	var existing_routes = get_routes(dptr, arvl);
	reg_faapref = /\<b\>Faa Pref Route([^\:]*)\:\<\/b\>\<br\/\>\<input[^\>]+value\=\"([^\"]+)\"/g;
	var faa_pref = reg_faapref.exec(existing_routes);
	if (faa_pref != null) {
		faa_pref['avg_fl'] = ((faa_pref['avg_fl'] === undefined) ? "" : faa_pref['avg_fl']);
	}

	if (faa_pref == null || faa_pref[2].trim().length == 0) {
		// Faa Pref not detected in existing routes
		warnings += "<span style=\"color:orange\">No existing FAA Pref route detected.<\/span><br/>";
		if (result_arr['faa_pref']['route'] !== undefined) {
			// Pref route in CDR list, but not already existing
			result += "result += \"<br/><br/><b>Faa Pref Route:</b>\";" + textarea_tabs;
			result += "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + result_arr['faa_pref']['route'] + "\\\" readonly>\"; \/\/ " + result_arr['faa_pref']['notes'];
		} else {
			// No pref routes in either CDR list or already existing
			result += "// result += \"<br/><br/><b>Faa Pref Route:</b>\"; // No FAA Pref route as of " + today_str + textarea_tabs + textarea_tabs;
		}
	} else {
		// Faa Pref exists in existing routes
		if (result_arr['faa_pref']['route'] !== undefined) {
			// Pref route in CDR list and already existing
			result += "result += \"<br/><br/><b>Faa Pref Route" + faa_pref['avg_fl'] + ":</b>\";" + textarea_tabs;
			if (result_arr['faa_pref']['route'].localeCompare(faa_pref[2])) {
				errors += "<b style=\"color:red\">Pref routes dont match- defaulted to existing route. Check CDR list vs. existing route<\/b><br\/>";
			} else { status += "Existing pref route matches CDR"; }
			result += "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + result_arr['faa_pref']['route'] + "\\\" readonly>\";";
		} else {
			// Pref route already existing, but not CDR list
			result += "result += \"<br/><br/><b>Faa Pref Route" + faa_pref['avg_fl'] + ":</b>\";" + textarea_tabs;
			result += "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + faa_pref[2] + "\\\" readonly>\";";
		}
	}

	// OTHER ROUTES

	// NON RNAV

	// CDRS
	if (debug_mode) {
		// console.log(faa_pref);
		// console.log(result_arr);
		// console.log(existing_routes);
	}

	return {'result' : result, 'errors' : errors, 'warnings' : warnings, 'status' : status};
}

function decs_route(input = null, cdr_list = null) {
	var result = "";
	var result_arr = {};
	var textarea_tabs = "";
	var faa_pref = "";
	if (input == null) { return ""; }

	reg_tmp = /[DI](\d+)\s+(\d+)\s[^\s]\s[^\s]\s[^\s]([^\n]*)\n\sARTC\sTEXT\s*([^‡¥]+?)REMARKS([^\n]*)\n/g;
	while(null != (z = reg_tmp.exec(input))) {
		var tmp_rid = parseInt(z[1]);
		var distance = parseInt(z[2]);

		// Comments
		z[3] = z[3].replaceAll("¶", "").replaceAll("¥", "").trim();
		z[5] = z[5].replaceAll("¶", "").replaceAll("¥", "").trim();

		// Route
		const rte_regexa = /[\s¶\n]/g;
		z[4] = z[4].replace(rte_regexa, '');
		z[4] = z[4].replaceAll(".DCT.",".").replaceAll("."," ").trim();
		z[4] = z[4].replaceAll("-"," ");
		z[4] = z[4].split("¥MD20")[0];
		z[4] = z[4].split("‡MD20")[0];

		// SIDS / STARS out of date
		z[4] = z[4].replace("PRICY3 KMCO", "PRICY4 KMCO");
		z[4] = z[4].replace("PRICY3 MCO", "PRICY4 MCO");
		z[4] = z[4].replace("RKSTR3 KLAS", "RKSTR4 KLAS");
		z[4] = z[4].replace("RKSTR3 LAS", "RKSTR4 LAS");
		z[4] = z[4].replace("CHOWW2 KLAS", "CHOWW3 KLAS");
		z[4] = z[4].replace("CHOWW2 LAS", "CHOWW3 LAS");
		z[4] = z[4].replace("GLADZ3 KMIA", "GLADZ4 KMIA");
		z[4] = z[4].replace("GLADZ3 MIA", "GLADZ4 MIA");
		
		// Origin
		if (z[4].substring(3, 4) == " ") {
			// Origin 4th character is space, need country prefix: IAH => KIAH
			z[4] = convert_icao(z[4].substring(0,3)) + " " + z[4].substring(4);
		}
		// Destination
		if ((z[4].substring(z[4].length - 4, z[4].length - 3)) == " ") {
			// Destination 1th character is space, need country prefix: IAH => KIAH
			z[4] = z[4].substring(0, z[4].length - 3) + convert_icao(z[4].substring(z[4].length - 3));
		}

		// Add to route array
		var cdr_name = null;
		var tmp_notes = "";
		var cdr_textarea_output = "";
		if (z[5].length > 0) {
			tmp_notes = z[5];
			if (z[3].length > 0) { tmp_notes += " || " + z[3]; }
		} else {
			if (z[3].length > 0) { tmp_notes =  z[3]; }
		}

		var tmp_tmp_notes = tmp_notes;
		if (tmp_notes.includes("CDR ")) {
			// CDR
			var cdr_regex = /CDR\s[A-Z]{6}([A-Z0-9]{2})/g;
			if ((tmp_cdrkey = cdr_regex.exec(tmp_notes)) != null) {
				var file_status = "";
				if (tmp_notes.includes("NO FILE") || tmp_notes.includes("COORD RQRD")) {
					file_status = " (Coord Req)";
				} else if (tmp_notes.includes("OK TO FILE")) {
					file_status = " (Ok to File)";
				}

				var output_value = "result += \"<br/>" + tmp_cdrkey[1] + file_status + ": <input class=\\\"cdr_input\\\" style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\";";
				tmp_notes += "<br/>CDR " + tmp_cdrkey[1] + ": <input style=\'width:75%\' value=\'" + output_value + "\' readonly>";
				cdr_name = tmp_cdrkey[1];
				cdr_textarea_output = output_value;
				var tmp_dptr = z[4].substring(0,4);
				if (tmp_dptr == "KDFW" && cdr_name == "0P") { // DFW
					faa_pref = "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR 0P";
				} else if (tmp_dptr == "KORD" && cdr_name == "0E") { // ORD
					faa_pref = "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR 0E";
				} else if (tmp_dptr == "KCLT" && cdr_name == "RP") { // CLT
					faa_pref = "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR RP";
				} else if (tmp_dptr == "KPHL" && cdr_name == "PH") { // PHL
					faa_pref = "result += \"<br/><input style=\\\"width:75%\\\" value=\\\"" + z[4] + "\\\" readonly>\"; \/\/ CDR PH";
				}
			}
		} else if (tmp_notes.includes("PLAYBOOK ")) {
			// PLAYBOOK
			var output_value = "result += \"<br/><input style=\\\"width:75%\\\"; value=\\\"" + z[4] + "\\\" readonly>\";";
			tmp_notes += "<br/><input style=\'width:75%\'; value=\'" + output_value + "\' readonly>";
			
			var playbook_regex = /PLAYBOOK ([^\|]+)/g;
			while(null != (pkey = playbook_regex.exec(tmp_tmp_notes))) {
				var output_value = "result += \"<br/>" + pkey[1] + ": <input style=\\\"width:75%\\\"; value=\\\"" + z[4] + "\\\" readonly>\";";
				tmp_notes += "<br/>PLAYBOOK " + pkey[1] + ": <input style=\'width:75%\'; value=\'" + output_value + "\' readonly>";
			}
		} else {
			// OTHER
			var output_value = "result += \"<br/><input style=\\\"width:75%\\\"; value=\\\"" + z[4] + "\\\" readonly>\";";
			tmp_notes += "<br/><input style=\'width:75%\'; value=\'" + output_value + "\' readonly>";
		}

		result_arr[parseInt(z[1])] = {'route':z[4], 'notes':tmp_notes, 'distance':parseInt(z[2]), 'cdr':cdr_name, 'cdr_textarea_output': cdr_textarea_output };
		textarea_tabs = ((["KCLT","KDFW","KLAX","KMIA","KORD","KPHX"].includes(z[4].substring(0, 4))) ? "\n\t\t\t" : "\n\t\t\t\t\t");

	} // End of Loop

	// Convert to Array to sort
	var sortable = [];
 	for (var key in result_arr) {
		// CDR, distance, notes, route_string
		sortable.push([result_arr[key]['cdr'], result_arr[key]['distance'], result_arr[key]['notes'], result_arr[key]['route'], result_arr[key]['cdr_textarea_output']]);
	}
	
	sortable.sort(function(x, y) {
		// CDR, distance, notes, route_string
		//  0       1        2         3
		if (x[0] != null || y[0] != null) {
			// At least one CDR
			if (x[0] != null && y[0] != null) {
				// Both CDRs
				return (x[0].localeCompare(y[0])); 
			} else {
				// One CDR, One Not
				if (x[0] == null) { return -1; }
				return 1;
			}
		} else {
			// Both not CDRS, sort by distance	
			if (x[1] < y[1]) {
				// x is higher on list
				return -1;
			}
			if (x[1] > y[1]) {
				// x is lower on list
				return 1;
			}
			return 0;
		}
	});

	var textarea_cdr_arr = [];
	var today = new Date();
	var tmp_arvl_arr = sortable[0][3].split(" ");
	var tmp_res_mid = "";
	var tmp_res_all = [];
	var dptr_tmp = "";
	var arvl_tmp = "";
	for (let i = 0; i < sortable.length; ++i) {
		tmp_res_mid += "<br/>" + sortable[i][3] + "<br/>" + sortable[i][2] + "<br/><hr>";
		if (sortable[i][0] != null) {
			textarea_cdr_arr.push(sortable[i][4]);
		}
		dptr_tmp = sortable[i][3].substring(0,4);
		arvl_tmp = sortable[i][3].substring(sortable[i][3].length - 4);
		tmp_res_all.push(sortable[i][3]);
	}
	var tmp_zz_todaystr = String(today.getMonth() + 1).padStart(2, '0') + "-" + String(today.getDate()).padStart(2, '0') + "-" + today.getFullYear();
	result += '<br/><textarea rows="5">case "' + convert_iata(tmp_arvl_arr[tmp_arvl_arr.length - 1]) + '": // Updated ' + tmp_zz_todaystr + textarea_tabs +
		'result += "<!-- Updated ' + tmp_zz_todaystr + (mandatory_routes_checked ? " M" : " ") + 'P -->"' + textarea_tabs +
		'result += "<br/><br/><b>Faa Pref Route:</b>";' + textarea_tabs +
		faa_pref + textarea_tabs + '// result += "<br/><br/><b>Non RNAV</b>"; // TODDO' + textarea_tabs;
	if (textarea_cdr_arr.length == 0) {
		result += '// result += "<br/><br/><b>CDRS</b>";  // No CDRs as of ' + tmp_zz_todaystr;
	} else {
		result += 'result += "<br/><br/><b>CDRS</b>";' + textarea_tabs + textarea_cdr_arr.join(textarea_tabs);
	}
	result += textarea_tabs + 'break; </textarea><br/>';
	result += '<br/><textarea rows="5">\/\* TODO - FOS ROUTES: ' + dptr_tmp + ' - ' + arvl_tmp + '\n' + tmp_res_all.join("\n") + '\n\*\/</textarea>';
	result += tmp_res_mid;
	result += '<textarea rows="15" cols="80">' + textarea_cdr_arr.join(textarea_tabs) + '\n</textarea><br/><br/>';
	return result;
}

function briefing_parse(fkeystxt = "") {
	var result = "briefing recognized // unable to parse";
	var tmp_regv = /PAGE\s[^\n]+([A-Z]{4})\-([A-Z]{4})\sAAL([^\n]+)\n[\s\S]+682\-315\-\d{2}(\d{2})\n[^\/]+\/(\d+)\s([^\/]+)\/[\s\S]+PLAN\sARR\sFUEL\s(\d+)\s(\d+)\n\-+\n([\s\S]+)ON TIME ANALYSIS\n\-+/g;

	/*
	* 1 - Dptr
	* 2 - Arvl
	* 3 - Flight #
	* 4 - Desk #
	* 5 - Date (Day only)
	* 6 - Tail #
	* 7 - PAF Lbs
	* 8 - PAF Mins
	* 9 - Fuel Ladder Text
	*/
	if ((z = (tmp_regv.exec(fkeystxt))) != null) {
		result = '<textarea rows="5" cols="80">' + z[3] + '\t' + z[1] + '\t' + z[2] + '\t' + z[6] + 
		'\t' + parseInt(z[7]) + // paf lbs
		'\t' + parseInt(z[8]) + // paf mins
		'\t' + (parseInt(z[8])/parseInt(z[7])).toFixed(2) + // mins per 1 lb
		'\t' + "" + // RPT PAF mins
		'\t' + '=IF(OFFSET(INDIRECT(ADDRESS(ROW(), COLUMN())),0,-1)<>"",ABS(OFFSET(INDIRECT(ADDRESS(ROW(), COLUMN())),0,-3)-OFFSET(INDIRECT(ADDRESS(ROW(), COLUMN())),0,-1)),"--")' + '\t'; // Delta RPAF || APAF
		var taxi_regex = /\-{5}\nTAXI[^\n\d]+(\d+)\s(\d+)[^\d]/g;
		if ((y = (taxi_regex.exec(z[9]))) != null) {
			result += '=IF(OFFSET(INDIRECT(ADDRESS(ROW(), COLUMN())),0,-2)<>"",ABS((OFFSET(INDIRECT(ADDRESS(ROW(), COLUMN())),0,-4)-' + parseInt(y[2]) + ')),"--")\t'; // Delta RPAF || APAF
		} else { result += ' \t'; }
		result += ' \t \t \t \t'; // Rptd ON Time // Rptd IN /Time / Rptd IN Fuel // RPT AAF Mins
		
		// TODO Delta AAF inc Taxi // Delta AAF
		
		result += '</textarea><br/>';
		
		/*
		while(null != (z = tmp_regv.exec(fkeystxt))) {}
		*/

		// console.log(z);
	}
	return result;
/*
ARPT FUEL TIME DIST
ENRT BRN SAT 005446 0047 244
--------------------------------------------------------------------
RSV 05538 0045
MAF 00332 0004
ALTN NONE 00000 0000
--------------------------------------------------------------------
MIN T/O 011316
--------------------------------------------------------------------
BASELINE 01184 0015
--------------------------------------------------------------------
TAXI DFW 00598 0025
RLS FUEL DFW 013098
--------------------------------------------------------------------
ADMIN 00946 0011
TOTAL DFW 014044
*/
}

Array.prototype.unique = function() {
    return this.filter(function (value, index, self) {
      return self.indexOf(value) === index;
    });
}
	
/*
function get_wind_limits(ac_type = null, tail = null) {
	if (ac_type == null) { return null; }
	var wind_limits = ["takeoff" => ["headwind" => 50], "landing" => ["headwind" => 50]];

	if (ac_type == "319S") {}
	if (["319W","H319"].includes(ac_type)) {
		if (parseInt(tail.charAt(0)) == 8) {
			// H319 with IAE engines
		} else {
			//H319 with CFM engines and 319W
		}
	}
	if (ac_type == "A320") {
		
	}
	if (ac_type == "H205") {
		
	}
	if (["321R", "321T", "321K"].includes(ac_type)) {
		if (parseInt(tail.charAt(0)) == 1) {
			// 321K with CFM engines
			
		} else {
			// 321R, 321T, and 321K with IAE engines
		}
	}
	if (ac_type == "321E") {
		
	}
	if (["738K", "738R", "738M"].includes(ac_type)) {
		// B737 NG and MAX
		wind_limits["xwind"] = [
			"takeoff" => ["tailwind" => 15],
			"landing" => ["tailwind" => 10],
			"hudto" => ["tailwind" => 10]
		];
		if (ac_type == "738M") {
			// B737 MAX Only

		}
	}
	return null;
}
*/
function get_dca_mtow(ac_type = null, tail = null) {
	if (ac_type == null) { return null; }
	if (ac_type == "319S") { return "MTOW 162.600 to comply with DCA curfew noise limits"; }
	if (["319W","H319"].includes(ac_type)) {
		// H319 with IAE engines
		if (parseInt(tail.charAt(0)) == 8) { return "MTOW 153.000 to comply with DCA curfew noise limits"; }
		//H319 with CFM engines and 319W
		return "MTOW 159.700 to comply with DCA curfew noise limits";
	}
	if (ac_type == "A320") { return "MTOW 165.500 to comply with DCA curfew noise limits"; }
	if (ac_type == "H205") { return "MTOW 158.900 to comply with DCA curfew noise limits"; }
	if (["321R", "321T", "321K"].includes(ac_type)) {
		// 321K with CFM engines
		if (parseInt(tail.charAt(0)) == 1) { return "MTOW 153.000 to comply with DCA curfew noise limits"; }
		// 321R, 321T, and 321K with IAE engines
		return "MTOW 184.400 to comply with DCA curfew noise limits";
	}
	if (ac_type == "321E") { return "No DCA curfew MTOW penalties for A321 NX"; }
	if (["738K", "738R"].includes(ac_type)) { return "MTOW 166.800 to comply with DCA curfew noise limits"; }
	if (ac_type == "738M") { return "No DCA curfew MTOW penalties for B737 MAX"; }
	return null;
}

function get_dca_mlw(ac_type = null, tail = null) {
	if (ac_type == null) { return null; }
	if (["319S", "319W", "H319"].includes(ac_type)) { return "No DCA curfew MLW penalties for A319"; }
	if (["A320", "H205"].includes(ac_type)) { return "No DCA curfew MLW penalties for A320"; }
	if (["321R", "321T", "321K"].includes(ac_type)) {
		// 321K with CFM engines
		if (parseInt(tail.charAt(0)) == 1) { return "MLW 131.700 to comply with DCA curfew noise limits"; }
		// 321R, 321T, and 321K with IAE engines
		return "MLW 166.400 to comply with DCA curfew noise limits";
	}
	if (ac_type == "321E") { return "No DCA curfew MLW penalties for A321 NX"; }
	if (["738K", "738R"].includes(ac_type)) { return "MLW 140.200 to comply with DCA curfew noise limits"; }
	if (ac_type == "738M") { return "No DCA curfew MLW penalties for B737 MAX"; }
	return null;
}

function get_ac_type(tail = "") {
	if (tail.length != 3) { return null; }
	var first = parseInt(tail.charAt(0));
	if (isNaN(first)) { return null; }
	switch (first) {
		case 0:
			if (S319.includes(tail)) { return "319S"; };
			break;
		case 1:
			if (A320.includes(tail)) { return "A320"; };
			if (A321.includes(tail)) { return "A321"; };
			if (K321.includes(tail)) { return "321K"; };
			break;
		case 2:
			if (A332.includes(tail)) { return "A332"; };
			break;
		case 3:
			if (M738.includes(tail)) { return "738M"; };
			if (K738.includes(tail)) { return "738K"; };
			if (R738.includes(tail)) { return "738R"; };
			if (["3PV", "3PW", "3PX"].includes(tail)) { return "738R"; }
			break;
		case 4:
			if (E321.includes(tail)) { return "321E"; };
			break;
		case 5:
			if (A321.includes(tail)) { return "A321"; };
			if (K321.includes(tail)) { return "321K"; };
			break;
		case 6:
			if (H205.includes(tail)) { return "H205"; };
			break;
		case 7:
			if (isNaN(parseInt(tail.charAt(1)))) {
				// Letter after initial 7 i.e. "7LH"
				if (B772.includes(tail)) { return "B772"; };
				if (W773.includes(tail)) { return "773W"; };
			} else {
				// Three numbers i.e. "777"
				if (T321.includes(tail)) { return "321T"; };
				if (H319.includes(tail)) { return "H319"; };
				if (W319.includes(tail)) { return "319W"; };
				if (R321.includes(tail)) { return "321R"; };
			}
			break;
		case 8:
			if (isNaN(parseInt(tail.charAt(1)))) {
				// Letter after initial 8 i.e. "8AL"
				if (E787.includes(tail)) { return "7878"; };
				if (N787.includes(tail)) { return "7879"; };
				if (P789.includes(tail)) { return "789P"; };
			} else {
				// Three numbers i.e. "876"
				if (H319.includes(tail)) { return "H319"; };
				if (R321.includes(tail)) { return "321R"; };
			}
			break;
		case 9:
			if (K321.includes(tail)) { return "321K"; };
			if (R321.includes(tail)) { return "321R"; };
			if (N321.includes(tail)) { return "321N"; };
			break;
	}
	return null;
}

function add_sara_rmks(arvl = null, result = "") {
	if (["AVL", "IFP", "BUR", "BTV", "DRO", "EGE", "GDL", "GUC", "HDN", "JAC", "EYW", "BJX", "MEX", "MSO", "MRY", "ONT", "PSP", "OAX", "RDM", "RNO", "SAN", "SFO", "SBP", "DCA"].includes(arvl)) {
		// result += "<br/><br/>SARA airport";
	}
	if (["GUC", "JAC", "EYW", "MEX", "OAX", "RDM", "SBP"].includes(arvl)) {
		result += ": CA needs 75 hrs in AC type// FAM page review required";
	} else if (arvl == "EGE") { result += ": Capt must have flown into EGE in the last 18 months"; }
	return result;
}

function get_month_name(id = -1) {
	if (id < 0 || id > 11) { return "NULL"; }
	return ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"][id];
}

function today(report_date = true) {
	var today = new Date();
	if (report_date && today.getHours() > 15) {
		today.setDate(today.getDate() + 1);
	}
	return (((today.getDate() < 10) ? ("0" + today.getDate()) : today.getDate()) + "-" +
		get_month_name(today.getMonth()) + "-" + today.getFullYear());
}

function clear_input (type = -1) {
	if (type == 0) {
		$("#outbound").val("");
	}
	$("#total").html("");
}

function cdrdoc_parse (text = "", as_text = false) {
	var return_null = false;
	var result = {};
	var result_str = 'get_computed_cdrs = function(dptr = \"XXX\", arvl = \"YYY\") {\n' +
		'\tdptr = ((dptr.length == 4) ? (dptr.substr(1, 4)) : dptr);\n' +
		'\tarvl = ((arvl.length == 4) ? (arvl.substr(1, 4)) : arvl);\n' +
		'\tvar result = \"\";\n\n\tswitch(dptr) {\n';

	var reg_tmp = /([A-Z]{3})([A-Z]{3})([^\t]{2})\t([A-Z]{4})\t([A-Z]{4})\t[^\t]*\t([^\t]+)\t[^\t]*\t[^\t]*\t[^\t]*\t([YN])/g;

	var first_arvl = true;
	var first_dptr = true;
	
	while(null != (z = reg_tmp.exec(text))) {
		if (result[z[1]] == null) {
			result[z[1]] = {};
			if (first_dptr) { first_dptr = false; }
			else {
				result_str += '\n\t\t\t}\n\t\tbreak;\n';
			}
			result_str += '\n\t\tcase \"' + z[1] + '\":\n\t\t\tswitch (arvl) {';
			first_arvl = true;
		}
		if (result[z[1]][z[2]] == null) {
			result[z[1]][z[2]] = {};
			if (first_arvl) { first_arvl = false; }
			else {
				result_str += '\n\t\t\t\t\tbreak;';
			}
			result_str += '\n\t\t\t\tcase \"' + z[2] + '\":';
		}
		if (result[z[1]][z[2]][z[3]] == null) {
			result[z[1]][z[2]][z[3]] = [z[6], z[7]];
			result_str += '\n\t\t\t\t\tresult += \"<br/>' + z[3] + '<span style=\\\"color:' + ((z[7] == "Y") ? 'green\\\"> (OK to File)' : 'red\\\"> (Coord Req)') + '</span>: <input class=\\\"cdr_input\\\" style=\\\"width:75%\\\" value=\\\"' + z[6] + '\\\" readonly>\";';
		} else { console.log("Duplicate found: " + z[1] + z[2] + z[3]); }
	}
	if (!first_arvl || !first_dptr) {
		result_str += '\n\t\t\t}\n\t\tbreak;\n\t}\n\treturn result;\n}';
	}
	return (return_null ? null : (as_text ? ('<br/><textarea>' + add_sids_and_stars_to_cdrs(result_str) + '</textarea>') : result));
}

function add_sids_and_stars_to_cdrs (result = "") {
	// SIDS
	result = result.replaceAll("KABQ CNX", ""); // TODO
	result = result.replaceAll("KABQ TCC", ""); // TODO
	result = result.replaceAll("KABQ FTI", "KABQ FYSTA3 FTI");
	result = result.replaceAll("KABQ ALS", "KABQ ATOMK3 ATOMK ALS");
	result = result.replaceAll("KABQ ABQ", "KABQ ABQ3 ABQ");
	result = result.replaceAll("KABQ ONM", ""); // TODO
	result = result.replaceAll("KABQ TXO", "KABQ MNZNO3 TXO");

	// KATL
	result = result.replaceAll("KATL KAJIN", ""); // TODO
	result = result.replaceAll("KATL SMLTZ", ""); // TODO

	// KBFL
	result = result.replaceAll("KBFL EHF", "KBFL MARIC4 EHF");
	result = result.replaceAll("KBFL PMD", "KBFL MARIC4 LHS PMD");

	// KBOS
	result = result.replaceAll("KBOS GLYDE", ""); // TODO
	result = result.replaceAll("KBOS BOSOX", ""); // TODO
	result = result.replaceAll("KBOS BURDY", ""); // TODO
	result = result.replaceAll("KBOS BLZZR", "KBOS BLZZR6 BLZZR");

	// KBUR
	result = result.replaceAll("KBUR LAS", "KBUR SLAPP2 LAS");
	result = result.replaceAll("KBUR HEC", "KBUR SLAPP2 HEC");
	result = result.replaceAll("KBUR BLH", "KBUR SLAPP2 BLH");
	result = result.replaceAll("KBUR DVC", "KBUR SLAPP2 LAS J146 DVC");
	result = result.replaceAll("KBUR CSTRO", "KBUR OROSZ2 CSTRO");
	result = result.replaceAll("KBUR PMD TRM BLH", "KBUR SLAPP2 BLH");
	result = result.replaceAll("KBUR PMD TRM", "KBUR VNY3 VNY TRM");
	result = result.replaceAll("KBUR TRM", "KBUR VNY3 VNY TRM");
	result = result.replaceAll("KBUR PMD", "KBUR VNY3 PMD");

	// KCLE
	result = result.replaceAll("KCLE BONZZ", ""); // TODO

	// KCVG
	result = result.replaceAll("KCVG HVQ", "KCVG GIPLE7 HVQ");
	result = result.replaceAll("KCVG IIU", ""); // TODO
	result = result.replaceAll("KCVG SITTR", ""); // TODO
	result = result.replaceAll("KCVG HYK", ""); // TODO
	result = result.replaceAll("KCVG RIKLE", ""); // TODO
	result = result.replaceAll("KCVG JODUB", ""); // TODO
	result = result.replaceAll("KCVG DQN", ""); // TODO
	result = result.replaceAll("KCVG TRFWA", ""); // TODO

	// KDEN
	result = result.replaceAll("KDEN LUFSE", ""); // TODO
	result = result.replaceAll("KDEN GLL", ""); // TODO

	// KELP
	result = result.replaceAll("KELP RUTER", ""); // TODO
	result = result.replaceAll("KELP EWM", ""); // TODO
	result = result.replaceAll("KELP ELP", ""); // TODO
	result = result.replaceAll("KELP FST", ""); // TODO
	result = result.replaceAll("KELP DRK", ""); // TODO

	// KEWR
	result = result.replaceAll("KEWR PARKE", ""); // TODO
	result = result.replaceAll("KEWR BREZY", ""); // TODO
	result = result.replaceAll("KEWR ZIMMZ", ""); // TODO
	result = result.replaceAll("KEWR BDR", ""); // TODO
	result = result.replaceAll("KEWR HAAYS", ""); // TODO
	result = result.replaceAll("KEWR BIGGY", ""); // TODO
	result = result.replaceAll("KEWR ELVAE", ""); // TODO
	result = result.replaceAll("KEWR NEION", ""); // TODO
	result = result.replaceAll("KEWR LANNA", ""); // TODO
	result = result.replaceAll("KEWR NEWEL", ""); // TODO
	result = result.replaceAll("KEWR COATE", ""); // TODO
	result = result.replaceAll("KEWR GAYEL", ""); // TODO
	result = result.replaceAll("KEWR MERIT", ""); // TODO
	result = result.replaceAll("KEWR GREKI", ""); // TODO
	result = result.replaceAll("KEWR BETTE", ""); // TODO
	result = result.replaceAll("KEWR BAYYS", ""); // TODO
	result = result.replaceAll("KEWR ELIOT", ""); // TODO
	result = result.replaceAll("KEWR WAVEY", ""); // TODO

	// KFAY
	result = result.replaceAll("KFAY HINTZ", ""); // TODO
	result = result.replaceAll("KFAY RDU", ""); // TODO
	result = result.replaceAll("KFAY JROSS", ""); // TODO
	result = result.replaceAll("KFAY TORQD", ""); // TODO

	// KFNT
	result = result.replaceAll("KFNT DERLO", ""); // TODO
	result = result.replaceAll("KFNT HHRNT", ""); // TODO
	result = result.replaceAll("KFNT MBS", ""); // TODO
	result = result.replaceAll("KFNT MONEE", ""); // TODO
	result = result.replaceAll("KFNT HUBBY", ""); // TODO
	result = result.replaceAll("KFNT KAYYS", ""); // TODO
	result = result.replaceAll("KFNT SMUUV", ""); // TODO

	// KFWA
	result = result.replaceAll("KFWA MIE", ""); // TODO
	result = result.replaceAll("KFWA PWE", ""); // TODO
	result = result.replaceAll("KFWA IIU", ""); // TODO
	result = result.replaceAll("KFWA APE", ""); // TODO
	result = result.replaceAll("KFWA PXV", ""); // TODO
	result = result.replaceAll("KFWA ROD", ""); // TODO
	result = result.replaceAll("KFWA RBS", ""); // TODO
	result = result.replaceAll("KFWA PNT", ""); // TODO
	result = result.replaceAll("KFWA OVR", ""); // TODO
	result = result.replaceAll("KFWA LNK", ""); // TODO
	result = result.replaceAll("KFWA JOT", ""); // TODO
	result = result.replaceAll("KFWA BVT", ""); // TODO
	result = result.replaceAll("KFWA FAM", ""); // TODO
	result = result.replaceAll("KFWA WHETT", ""); // TODO

	// KGRR
	result = result.replaceAll("KGRR FWA", ""); // TODO
	result = result.replaceAll("KGRR OBK", ""); // TODO
	result = result.replaceAll("KGRR APE", ""); // TODO
	result = result.replaceAll("KGRR OLYEE", ""); // TODO
	result = result.replaceAll("KGRR BAE", ""); // TODO
	result = result.replaceAll("KGRR SMUUV", ""); // TODO
	result = result.replaceAll("KGRR PXV", ""); // TODO
	result = result.replaceAll("KGRR VIO", ""); // TODO

	// KIND
	result = result.replaceAll("KIND OKK", ""); // TODO
	result = result.replaceAll("KIND BVT", ""); // TODO
	result = result.replaceAll("KIND DQN", ""); // TODO
	result = result.replaceAll("KIND SHB", ""); // TODO
	result = result.replaceAll("KIND OOM", ""); // TODO
	result = result.replaceAll("KIND TTH", ""); // TODO
	result = result.replaceAll("KIND PXV", ""); // TODO
	result = result.replaceAll("KIND MIE", ""); // TODO
	result = result.replaceAll("KIND DROSE", ""); // TODO
	result = result.replaceAll("KIND BONNT", ""); // TODO
	result = result.replaceAll("KIND VHP", ""); // TODO

	// KJFK
	result = result.replaceAll("KJFK BAYYS", ""); // TODO
	result = result.replaceAll("KJFK COATE", ""); // TODO
	result = result.replaceAll("KJFK BDR", ""); // TODO
	result = result.replaceAll("KJFK HAAYS", ""); // TODO
	result = result.replaceAll("KJFK RBV", ""); // TODO
	result = result.replaceAll("KJFK WAVEY", ""); // TODO
	result = result.replaceAll("KJFK NEION", ""); // TODO
	result = result.replaceAll("KJFK GAYEL", ""); // TODO
	result = result.replaceAll("KJFK SHIPP", ""); // TODO
	result = result.replaceAll("KJFK MERIT", ""); // TODO
	result = result.replaceAll("KJFK GREKI", ""); // TODO
	result = result.replaceAll("KJFK BETTE", ""); // TODO
	result = result.replaceAll("KJFK DIXIE", ""); // TODO
	result = result.replaceAll("KJFK WHITE", ""); // TODO
	result = result.replaceAll("KJFK ARD", ""); // TODO

	// KLAS
	result = result.replaceAll("KLAS GUP", "KLAS NIITZ4 SSKEE GUP");
	result = result.replaceAll("KLAS INW", "KLAS NIITZ4 SSKEE INW");
	result = result.replaceAll("KLAS TBC", "KLAS NIITZ4 HOCEE TBC");
	result = result.replaceAll("KLAS DVC", "KLAS GIDGT3 TUKRR DVC");
	result = result.replaceAll("KLAS PGS",   "KLAS HOOVR8 PGS");
	result = result.replaceAll("KLAS VERKN", "KLAS GIDGT3 VERKN");
	result = result.replaceAll("KLAS TUKRR", "KLAS GIDGT3 TUKRR");
	result = result.replaceAll("KLAS SSKEE", "KLAS NIITZ4 SSKEE");
	result = result.replaceAll("KLAS HOCEE", "KLAS NIITZ4 HOCEE");
	result = result.replaceAll("KLAS ZAYNE", "KLAS RASLR3 ZAYNE");
	result = result.replaceAll("KLAS FRNCK", "KLAS RATPK3 FRNCK");
	result = result.replaceAll("KLAS JAYSN", "KLAS LOHLA3 JAYSN");
	result = result.replaceAll("KLAS KENNO", "KLAS JOHKR5 KENNO");
	result = result.replaceAll("KLAS LVELL", "KLAS RADYR2 LVELL");
	result = result.replaceAll("KLAS HEC",   "KLAS RADYR2 HEC");
	result = result.replaceAll("KLAS DRK", ""); // TODO
	result = result.replaceAll("KLAS BCE", ""); // TODO
	result = result.replaceAll("KLAS TBC", ""); // TODO
	result = result.replaceAll("KLAS BIKKR", ""); // TODO

	// KLAX
	result = result.replaceAll("KLAX LAS", "KLAX ORCKA5 LAS");
	result = result.replaceAll("KLAX BEALE", "KLAX ORCKA5 BEALE");
	result = result.replaceAll("KLAX CLEEE", "KLAX DOTSS2 CLEEE");
	result = result.replaceAll("KLAX CNERY", "KLAX DOTSS2 CNERY");
	// result = result.replaceAll("KLAX BLH", "KLAX BLH"); // todo non rnav qqq
	result = result.replaceAll("KLAX TCATE", "KLAX PNDAH2 TCATE");
	result = result.replaceAll("KLAX FICKY", "KLAX ZILLI5 FICKY");
	result = result.replaceAll("KLAX DVC", ""); // TODO
	result = result.replaceAll("KLAX CSTRO", ""); // TODO
	result = result.replaceAll("KLAX IKAYE", ""); // TODO

	// KLGA
	result = result.replaceAll("KLGA BAYYS", ""); // TODO
	result = result.replaceAll("KLGA ZIMMZ", ""); // TODO
	result = result.replaceAll("KLGA HAAYS", ""); // TODO
	result = result.replaceAll("KLGA BDR", ""); // TODO
	result = result.replaceAll("KLGA BIGGY", ""); // TODO
	result = result.replaceAll("KLGA PARKE", ""); // TODO
	result = result.replaceAll("KLGA WHITE", ""); // TODO
	result = result.replaceAll("KLGA NEION", ""); // TODO
	result = result.replaceAll("KLGA LANNA", ""); // TODO
	result = result.replaceAll("KLGA NEWEL", ""); // TODO
	result = result.replaceAll("KLGA JFK", ""); // TODO
	result = result.replaceAll("KLGA MERIT", ""); // TODO
	result = result.replaceAll("KLGA COATE", ""); // TODO
	result = result.replaceAll("KLGA GREKI", ""); // TODO
	result = result.replaceAll("KLGA GAYEL", ""); // TODO
	result = result.replaceAll("KLGA BETTE", ""); // TODO
	result = result.replaceAll("KLGA ELIOT", ""); // TODO
	result = result.replaceAll("KLGA BREZY", ""); // TODO

	// KMSP
	result = result.replaceAll("KMSP GEP", ""); // TODO
	result = result.replaceAll("KMSP HYR", ""); // TODO
	result = result.replaceAll("KMSP DLH", ""); // TODO

	// KMSY
	result = result.replaceAll("KMSY AEX", ""); // TODO
	result = result.replaceAll("KMSY NTCHZ", ""); // TODO
	result = result.replaceAll("KMSY PAYTN", ""); // TODO
	result = result.replaceAll("KMSY CEW", ""); // TODO
	result = result.replaceAll("KMSY SJI", ""); // TODO
	result = result.replaceAll("KMSY MCB", ""); // TODO
	result = result.replaceAll("KMSY JEPEG", ""); // TODO
	result = result.replaceAll("KMSY CATLN", ""); // TODO
	result = result.replaceAll("KMSY MEI", ""); // TODO
	result = result.replaceAll("KMSY LBY", ""); // TODO
	result = result.replaceAll("KMSY IAH", ""); // TODO
	result = result.replaceAll("KMSY KCEEE", ""); // TODO
	result = result.replaceAll("KMSY LFT", ""); // TODO
	result = result.replaceAll("KMSY BLVNS", ""); // TODO
	result = result.replaceAll("KMSY LAMMY", ""); // TODO
	result = result.replaceAll("KMSY TBD", ""); // TODO
	result = result.replaceAll("KMSY REDFN", ""); // TODO
	result = result.replaceAll("KMSY SQS", ""); // TODO

	// KONT
	result = result.replaceAll("KONT JLI", ""); // TODO
	result = result.replaceAll("KONT BLH", "KONT RAJEE4 MTBAL CNERY BLH");
	result = result.replaceAll("KONT DVC", "KONT SNSHN5 LAS J146 DVC");
	result = result.replaceAll("KONT EHF", "KONT SNSHN5 EHF");
	result = result.replaceAll("KONT LAS", "KONT SNSHN5 LAS");
	result = result.replaceAll("KONT AVRRY", "KONT RAJEE4 AVRRY");
	result = result.replaceAll("KONT MTBAL", "KONT RAJEE4 MTBAL");

	// KPHX
	result = result.replaceAll("KPHX PXR", ""); // TODO
	result = result.replaceAll("KPHX JUDTH", ""); // TODO
	result = result.replaceAll("KPHX TMACK", ""); // TODO

	// KPIT
	result = result.replaceAll("KPIT AHTIY", ""); // TODO
	result = result.replaceAll("KPIT DILNE", ""); // TODO
	result = result.replaceAll("KPIT TYROO", ""); // TODO
	result = result.replaceAll("KPIT EWC", ""); // TODO
	result = result.replaceAll("KPIT CKB", ""); // TODO
	result = result.replaceAll("KPIT KEMAN", ""); // TODO
	result = result.replaceAll("KPIT BSV", ""); // TODO
	result = result.replaceAll("KPIT MGW", ""); // TODO
	result = result.replaceAll("KPIT JST", ""); // TODO

	// KPSP
	result = result.replaceAll("KPSP BLH", "KPSP HWRRD1 BLH");
	result = result.replaceAll("KPSP PMD", "KPSP LGANN1 PMD");
	result = result.replaceAll("KPSP PSP", "KPSP CATH1 PSP");
	result = result.replaceAll("KPSP TNP", "KPSP CATH1 PSP V370 TNP");
	result = result.replaceAll("KPSP TRM", "KPSP HWRRD1 TRM");

	// KPVD
	result = result.replaceAll("KPVD PUT", ""); // TODO
	result = result.replaceAll("KPVD JUMPR", ""); // TODO
	result = result.replaceAll("KPVD PVD", ""); // TODO
	result = result.replaceAll("KPVD SEY", ""); // TODO

	// KPWM
	result = result.replaceAll("KPWM ALB", ""); // TODO
	result = result.replaceAll("KPWM GDM", ""); // TODO

	// KRDU
	result = result.replaceAll("KRDU CATAR", ""); // TODO

	// KRIC
	result = result.replaceAll("KRIC HPW", ""); // TODO
	result = result.replaceAll("KRIC HOUKY", ""); // TODO
	result = result.replaceAll("KRIC HCM", ""); // TODO
	result = result.replaceAll("KRIC GVE", ""); // TODO

	// KROC
	result = result.replaceAll("KROC GEE", ""); // TODO
	result = result.replaceAll("KROC BURST", ""); // TODO
	result = result.replaceAll("KROC BEEPS", ""); // TODO
	result = result.replaceAll("KROC GOATR", ""); // TODO
	result = result.replaceAll("KROC AIRCO", ""); // TODO
	result = result.replaceAll("KROC HANKK", ""); // TODO
	result = result.replaceAll("KROC AUDIL", ""); // TODO
	result = result.replaceAll("KROC CFB", ""); // TODO

	// KRSW
	result = result.replaceAll("KRSW DYLYN", ""); // TODO
	result = result.replaceAll("KRSW MOOKY", ""); // TODO
	result = result.replaceAll("KRSW CHARO", ""); // TODO
	result = result.replaceAll("KRSW AABER", ""); // TODO
	result = result.replaceAll("KRSW MARCI", ""); // TODO

	// KSAN
	result = result.replaceAll("KSAN IPL", ""); // TODO
	result = result.replaceAll("KSAN FTI", "KSAN TGOLD PXR J18 FTI");
	result = result.replaceAll("KSAN GBN", "KSAN ZZOOO4 GBN");
	result = result.replaceAll("KSAN IKAYE", "KSAN PADRZ2 IKAYE");
	result = result.replaceAll("KSAN LAX EHF", "KSAN PADRZ7 EHF");
	result = result.replaceAll("KSAN MTBAL", "KSAN ZZOOO4 MTBAL");
	result = result.replaceAll("KSAN TGOLD", "KSAN ZZOOO4 TGOLD");

	// KSBA
	result = result.replaceAll("KSBA LAS", ""); // TODO
	result = result.replaceAll("KSBA KPTIN", ""); // TODO
	result = result.replaceAll("KSBA PMD", ""); // TODO

	// KSBP
	result = result.replaceAll("KSBP LAS", ""); // TODO
	result = result.replaceAll("KSBP PMD", ""); // TODO

	// KSBY
	result = result.replaceAll("KSBY OUTLA", ""); // TODO
	result = result.replaceAll("KSBY SAWED", ""); // TODO
	result = result.replaceAll("KSBY LAFLN", ""); // TODO

	// KSNA
	result = result.replaceAll("KSNA AVRRY", "KSNA PIGGN3 AVRRY");
	result = result.replaceAll("KSNA BEALE", "KSNA FINZZ3 BEALE");
	result = result.replaceAll("KSNA BLH", "KSNA PIGGN3 CNERY BLH");
	result = result.replaceAll("KSNA CNERY", "KSNA PIGGN3 CNERY");
	result = result.replaceAll("KSNA TCATE", "KSNA PIGGN3 TCATE");
	result = result.replaceAll("KSNA DVC", "KSNA FINZZ3 LAS J146 DVC");
	result = result.replaceAll("KSNA EHF", "KSNA HHERO3 EHF");
	result = result.replaceAll("KSNA LAS", "KSNA FINZZ3 LAS");

	// KTUS
	result = result.replaceAll("KTUS SSO", ""); // TODO
	result = result.replaceAll("KTUS GBN", ""); // TODO

	// CYOW
	result = result.replaceAll("CYOW OLIGO", ""); // TODO
	result = result.replaceAll("CYOW YOW", ""); // TODO
	result = result.replaceAll("CYOW TUKIR", ""); // TODO
	result = result.replaceAll("CYOW ART", ""); // TODO

	// CYQB
	result = result.replaceAll("CYQB UDBAM", ""); // TODO
	result = result.replaceAll("CYQB PENTU", ""); // TODO

	// CYUL
	result = result.replaceAll("CYUL TAMKO", ""); // TODO
	result = result.replaceAll("CYUL KESKA", ""); // TODO
	result = result.replaceAll("CYUL FAWNS", ""); // TODO
	result = result.replaceAll("CYUL BOBKI", ""); // TODO

	// CYYZ
	result = result.replaceAll("CYYZ OLAMO", ""); // TODO
	result = result.replaceAll("CYYZ VERDO", ""); // TODO
	result = result.replaceAll("CYYZ NUGOP", ""); // TODO
	result = result.replaceAll("CYYZ TULEK", ""); // TODO

	return result;
}

</script>
