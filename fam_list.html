<head>
	<title>SHelper</title>
	<meta name="viewport" content="user-scalable=no, width=device-width">
	<meta charset="UTF-8">

	<link href="css/bootstrap.min.css" rel="stylesheet" >
	<link href="css/style.css" rel="stylesheet" type="text/css">

	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="/spiderwiki/wikispider.js"></script>
</head>

<body>
  ID: <input id="fam_id" name="fam_id" val="1" />
  <button onclick="new_id()">Go</button><br/>
	Outbound WSC: <textarea id="outbound" rows="5"></textarea>
	<a id="wsc_link" href="" class="button" target="_blank">Go</a>&nbsp;&nbsp;<button onclick="clear_input(0)">Clear</button><br/>
	Inbound WK: <textarea id="inbound" rows="5"></textarea>
	<a id="wk_link" href="" class="button" target="_blank">Go</a>&nbsp;&nbsp;<button onclick="clear_input(1)">Clear</button><br/>
	Ans: <textarea id="ans_txt" rows="5" style="width:300px"></textarea><div id="total"></div>
  <button onclick="compute()">Go</button>&nbsp;&nbsp;<button onclick="clear_input(1)">Clear</button><br/>
</body>

<script>
function clear_input (type = -1) {
	if (type == 0) {
		$("#outbound").val("");
	} else if (type == 1) {
		$("#inbound").val("");
	}
}

function new_id() {
	var fam = get_fam_by_id(get_next_fam(parseInt($("#fam_id").val())));
	if (fam !== null) {
		$("#fam_id").val(fam[0]);
		$("#wsc_link").attr("href", ("view-source:https://wsc.nmbe.ch/family/" + fam[0]));
		$("#wk_link").attr("href", ("https://en.wikipedia.org/w/index.php?title=List_of_" + fam[1] + "_species&action=edit"));
	}
}

function compute() {
	var errors = [];
	var today = new Date();
	var fam = get_fam_by_id(parseInt($("#fam_id").val()));
	var wsc_html = $("#outbound").val();
	var wk_html = $("#inbound").val();
	var month = (((today.getMonth() + 1) < 10) ? ("0" + (today.getMonth() + 1)) : (today.getMonth() + 1));
	var day = ((today.getDate() < 10) ? ("0" + today.getDate()) : today.getDate());
	var result = "{{short description|Wikipedia list article}}\n{{TOC right}}\n{{main|" + fam[1] + "}}\n" +
		"This page lists all described [[genus|genera]] and [[species]] of the spider family '''" + fam[1] +
		"'''. {{As of|" + today.getFullYear() + "|" + month + "}}, the [[World Spider Catalog]] accepts " + (wsc_html.match(/genusTitle/g) || []).length +
		" species in " + (wsc_html.match(/speciesTitle/g) || []).length + " genera:<ref name=NMBE>{{cite web| title=" +
		(wsc_html.match(/Family\: [a-zA-Z]+\<\/strong\>([^\<]+)\<span class\=\"lsid\"\>\[urn\:lsid/g)) + "| website=World Spider Catalog Version 20.0| accessdate=" +
		today.getFullYear() + "-" + month + "-" + day + "| year=" +  today.getFullYear() + "| publisher=Natural History Museum Bern| url=http://www.wsc.nmbe.ch/family/" +
		fam[0] + "| doi=10.24436/2}}</ref>\n\n";

	// WSC parse
	var gen_list = {};
	var tmp_gens = wsc_html.split('genusTitle');
	for (var i = 1; i < tmp_gens.length; i++) {
		var tmp_specs = tmp_gens[i].split('speciesTitle');
        	var genreg = /Gen\.\s\<strong\>\<i\>([^\<]+)\<\/i\>\<\/strong\>([^\<]+)\<span class\=\"lsid/g;
        	var g_props = genreg.exec(tmp_gens[i]);
        	var tmp_g = {'name':g_props[1], 'auth':g_props[2].trim(), 'species':[]};
		for (var j = 1; j < tmp_specs.length; j++) {
            		var reg = /\<strong\>\<i\>([^\<]+)\<\/i\>\<\/strong\>\<\/a\>([^\<]+)\<[^\|]+\|[^\|]+\|([^\[]+)&nbsp;&nbsp;&nbsp; \[urn:lsid:/g;
            		var spc_list = reg.exec(tmp_specs[j]);
            		tmp_g['species'].push({'name':spc_list[1], 'auth':spc_list[2].trim(), 'loc':spc_list[3].trim()});
		}
        	gen_list[g_props[1]] = tmp_g;
	}

	// WK parse
	tmp_gens = wk_html.split("==''");
	for(var i = 1; i < tmp_gens.length; i++) {
		var genreg = /\'\'\[\[([^\s]+)\]\]\'\'\s*\<small\>([^\<]+)\<\/small\>/g;
		var g_props = genreg.exec(tmp_gens[i]);
		var g_split = tmp_gens[i].split(g_props[0]);
		var tmp_g = {'name':g_props[1], 'auth':g_props[2].trim(), 'species':[]};
/*
		// Species
		var spec_reg = /\*\s*\'\'\[\[([^\]]+)\]\]\'\'\s*\<small\>([^\<]+)\<\/small\>\s\—([^\n]+)\n/g
		var net = 0;
		while((result2 = spec_reg.exec(g_split[1])) !== null && net < 1000) {
			tmp_g['species'].push({'name':result2[1], 'auth':result2[2].trim(), 'loc':result2[3]});
			net++;
		}
*/
		// Images
		var img_list = [];
		var img_reg1 = /image\d*\s*\=\s*([^\n]+)\n\|\scaption\d*\s*\=\s*([^\n\}]+)[\n\}]/g;
		net = 0;
		while((result2 = img_reg1.exec(g_split[0])) !== null && net < 1000) {
			img_list.push({'img':result2[1], 'caption':result2[2]});
			net++;
		} net = 0;
		var img_reg2 = /\[\[Image\:([^\|]+)\|[^\n]+\|([^\n]+)\]\]\n/g
		while((result2 = img_reg2.exec(g_split[0])) !== null && net < 1000) {
			img_list.push({'img':result2[1], 'caption':result2[2]});
			net++;
		}

		// Compare to WSC
		if (gen_list[g_props[1]] === undefined) {
			// Not in WSC
			errors.push('"' + g_props[1] + '" is not listed in the WSC');
		} else {
			result += "==''" + g_props[1] + "''==\n";
			if (img_list.length > 0) {
				result += "{{multiple image\n| title = ''" + g_props[1] + "''\n| direction = vertical";
				for (var k = 0; k < img_list.length; k++) {
					result += "| image" + (k + 1) + " = " + img_list[k]['img'].trim() +
						"\n| caption" + (k + 1) + " = " + img_list[k]['caption'].trim();
				}
				result += "}}\n";
			} else {
				// No images
				result += "<!--Use this template to add pictures\n{{multiple image\n| title = ''" +
					g_props[1] + "''\n| direction = vertical\n| image1 = \n| caption1 = ''[[]]''\n" +
					"| image2 = \n| caption2 = ''[[]]''\n}}-->\n";
			}

			// Species
			// TODO: Check Link
			result += "''[[" + g_props[1] + "]]'' <small>" + g_props[2] + "</small>\n";
			for (var k = 0; k < gen_list[g_props[1]]['species'].length; k++) {
				//TODO: Use first letter abbreviation in link
				result += "* ''[[" + gen_list[g_props[1]]['species'][k]['name'] + "]]'' <small>" +
					gen_list[g_props[1]]['auth'] + "</small> — " + gen_list[g_props[1]]['loc'] + "\n";
				// TODO: Type species
			}
		} // end of genus exists in WSC
		result += "==References==\n{{Reflist}}\n\n{{Araneae}}\n\n{{DEFAULTSORT:" + g_props[1] +
			"}}\n\n[[Category:Lists of spider species by family|" + g_props[1] +
			"]]\n[[Category:" + g_props[1] + "| ]]";
		$('#ans_txt').val(result);
	}
}
</script>
