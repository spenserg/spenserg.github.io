<head>
	<title>SHelper</title>
	<meta name="viewport" content="user-scalable=no, width=device-width">
	<meta charset="UTF-8">

	<link href="css/bootstrap.min.css" rel="stylesheet" >
	<link href="css/style.css" rel="stylesheet" type="text/css">

	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="/spiderwiki/wikispider.js"></script>
</head>

<body>
  ID: <input id="fam_id" name="fam_id" val="1" />
  <button onclick="new_id()">Go</button><br/>
	Outbound WSC: <textarea id="outbound" rows="5"></textarea>
	<a id="wsc_link" href="" class="button" target="_blank">Go</a>&nbsp;&nbsp;<button onclick="clear_input(0)">Clear</button><br/>
	Inbound WK: <textarea id="inbound" rows="5"></textarea>
	<a id="wk_link" href="" class="button" target="_blank">Go</a>&nbsp;&nbsp;<button onclick="clear_input(1)">Clear</button><br/>
	Ans: <textarea id="ans_txt" rows="5" style="width:300px"></textarea><div id="total"></div>
  <button onclick="compute()">Go</button>&nbsp;&nbsp;<button onclick="clear_input(1)">Clear</button><br/>
</body>

<script>
function clear_input (type = -1) {
	if (type == 0) {
		$("#outbound").val("");
	} else if (type == 1) {
		$("#inbound").val("");
	}
}

function new_id() {
	var fam = get_fam_by_id(get_next_fam(parseInt($("#fam_id").val())));
	if (fam !== null) {
		$("#fam_id").val(fam[0]);
		$("#wsc_link").attr("href", ("view-source:https://wsc.nmbe.ch/family/" + fam[0]));
		$("#wk_link").attr("href", ("https://en.wikipedia.org/w/index.php?title=List_of_" + fam[1] + "_species&action=edit"));
	}
}

function compute() {
	var errors = [];
	var today = new Date();
	var month_num = ((today.getMonth() == 0) ? 12 : today.getMonth());
	var month = ((month_num < 10) ? ("0" + month_num) : month_num);
	var day = ((today.getDate() < 10) ? ("0" + today.getDate()) : today.getDate());

	var wsc_html = $("#outbound").val();
	var wk_html = $("#inbound").val();
	if ($("#fam_id").val().trim().length == 0 && wsc_html.length > 0) {
		var fidreg = /\/familydetail\/(\d+)\"/g;
		$("#fam_id").val(fidreg.exec(wsc_html)[1]);
	}
	var fam = get_fam_by_id(parseInt($("#fam_id").val()));
	var result = "{{short description|Wikipedia list article}}\n{{TOC right}}\n{{main|" + fam[4].replace("_"," ") + "}}\n" +
		"This page lists all described [[species]] of the spider family '''" + fam[1] +
		"''' {{as of|" + ((month == 12) ? (today.getFullYear() - 1) : today.getFullYear()) +
	    	"|" + month + "|lc=y}}:<ref name=NMBE>{{cite web| title=";
	var wsct_reg = /(Family\: [a-zA-Z]+)\<\/strong\>([^\<]+)\<span class\=\"lsid\"\>\[urn\:lsid/g;
	var wsc_title = wsct_reg.exec(wsc_html);
	result += wsc_title[1].trim() + " " + wsc_title[2].trim() +
		"| website=World Spider Catalog Version 20.0| accessdate=" + today.getFullYear() + "-" + 
		((today.getMonth() < 9) ? ("0" + (today.getMonth() + 1)) : (today.getMonth() + 1)) + "-" + day +
		"| year=" +  today.getFullYear() + "| publisher=Natural History Museum Bern| url=http://www.wsc.nmbe.ch/family/" +
		fam[0] + "| doi=10.24436/2}}</ref>\n\n";

	// WSC parse
	var gen_list = {};
	var tmp_gens = wsc_html.split('genusTitle');
	for (var i = 1; i < tmp_gens.length; i++) {
		var tmp_specs = tmp_gens[i].split('speciesTitle');
        	var genreg = /Gen\.\s\<strong\>\<i\>([^\<]+)\<\/i\>\<\/strong\>([^\<]+)\<span class\=\"lsid[\s\S]+genusdetail\/(\d+)\"\>/g;
        	var g_props = genreg.exec(tmp_gens[i]);
		rgen = get_gen_by_id(g_props[3]);
        	var tmp_g = {'id':((rgen == null) ? 0 : rgen[0]), 'name':g_props[1], 'auth':g_props[2].trim(), 'species':[], 'img':[], 'subfamily':""};
		for (var j = 1; j < tmp_specs.length; j++) {
            		var reg = /\<strong\>\<i\>([^\<]+)\<\/i\>\<\/strong\>\<\/a\>([^\<]+)\<[^\|]+\|[^\|]+\|([^\[]+)\[urn:lsid:/g;
            		var spc_list = reg.exec(tmp_specs[j]);
            		tmp_g['species'].push({'name':spc_list[1], 'auth':spc_list[2].replaceAll('&nbsp;', '').trim(),
					       'loc':spc_list[3].replaceAll('&nbsp;','').trim(), 'type':tmp_specs[j].includes(" * ")
			});
		}
		if (rgen == null) {
			errors.push('"' + g_props[1] + '" is not in database');
			tmp_g['link'] = g_props[1];
		} else {
			tmp_g['link'] = ((g_props[1].localeCompare(rgen[2]) == 0) ? rgen[2] : (rgen[2] + "|" + g_props[1]));
		}
        	gen_list[g_props[1]] = tmp_g;
	}

	// WK parse
	tmp_gens = wk_html.split("==''");
	for(var i = 1; i < tmp_gens.length; i++) {
		var genreg = /\'\'\[\[([^\]]+)\]\]\'\'\s*\<small\>([^\<]+)\<\/small\>([^\n]*)\n/g;
		var g_props = genreg.exec(tmp_gens[i]);
		var g_split = tmp_gens[i].split(g_props[0]);
		if (g_props[1].includes("|")) {
			g_props[1] = g_props[1].split("|")[1].trim();
		}

		// Images
		var img_list = [];
		var img_reg1 = /image\d*\s*\=\s*([^\n]+)\n\|\scaption\d*\s*\=\s*([^\n\}]+)[\n\}]/g;
		net = 0;
		while((result2 = img_reg1.exec(g_split[0])) !== null && net < 1000) {
			if (result2[1].replace("'", "").replace('"',"").trim().length > 0 &&
			   result2[2].replace("[","").replace("]","").replace("'","").replace('"',"").trim().length > 0) {
				// Image and Caption are not empty
				img_list.push({'img':result2[1], 'caption':result2[2]});
			}
			net++;
		} net = 0;
		var img_reg2 = /\[\[Image\:([^\|]+)\|[^\n]+\|([^\n]+)\]\]\n/g
		while((result2 = img_reg2.exec(g_split[0])) !== null && net < 1000) {
			img_list.push({'img':result2[1], 'caption':result2[2]});
			net++;
		}

		// Compare to WSC
		if (gen_list[g_props[1]] === undefined) {
			// Not in WSC
			errors.push('"' + g_props[1] + '" is not listed in the WSC');
		} else {
			gen_list[g_props[1]]['img'] = img_list;
			gen_list[g_props[1]]['subfamily'] = g_props[3].replace("-", "").trim();
		}
	}

	for(var name in gen_list) {
		var genus = gen_list[name];
		result += "==''" + name + "''==\n";
		if (genus['img'].length > 0) {
			result += "{{multiple image\n| title = ''" + name + "''\n| direction = vertical\n| align = right\n";
			for (var k = 0; k < genus['img'].length; k++) {
				result += "| image" + (k + 1) + " = " + genus['img'][k]['img'].trim() +
					"\n| caption" + (k + 1) + " = " + genus['img'][k]['caption'].trim() + "\n";
			}
			result += "}}\n";
		} else {
			// No images
			result += "<!--Use this template to add pictures\n{{multiple image\n| title = ''" +
				name + "''\n| direction = vertical\n| image1 = \n| caption1 = ''[[]]''\n" +
				"| image2 = \n| caption2 = ''[[]]''\n}}-->\n";
		}

		// Species
		result += "''[[" + genus['link'] + "]]'' <small>" + genus['auth'] + "</small>" +
			((genus['subfamily'].length > 0) ? (" - " + genus['subfamily']) : "") + "\n";
		for (var k = 0; k < gen_list[name]['species'].length; k++) {
			if (gen_list[name]['species'][k]['name'].split(" ").length == 3) {
				// Subspecies
				var gn_split = gen_list[name]['species'][k]['name'].split(" ");
				var prev_gen = gen_list[name]['species'][k - 1];
				result += "** ''" + gn_split[0].charAt(0).toUpperCase() + ". " +
					gn_split[1].charAt(0).toLowerCase() + ". " + gn_split[1].toLowerCase() + "'' <small>" +
					prev_gen['auth'] + "</small> - " + prev_gen['loc'] + "\n" +
					"** ''" + gn_split[0].charAt(0).toUpperCase() + ". " +
					gn_split[1].charAt(0).toLowerCase() + ". " + gn_split[2].toLowerCase() + "''";
			} else {
				result += "* ''[[" + gen_list[name]['species'][k]['name'] + "|" +
					gen_list[name]['species'][k]['name'].split(" ")[0].charAt(0).toUpperCase() +
					". " + gen_list[name]['species'][k]['name'].split(" ")[1] + "]]''";
			}
			result += " <small>" + gen_list[name]['species'][k]['auth'] + "</small> " +
				(gen_list[name]['species'][k]['type'] ? "([[Type species|type]]) " : "") +
				"â€” " + gen_list[name]['species'][k]['loc'] + "\n";
		}
		result += "\n";
	}
	result += "==References==\n{{Reflist}}\n\n{{Araneae}}\n\n{{DEFAULTSORT:" + fam[1] +
		"}}\n\n[[Category:Lists of spider species by family|" + fam[1] + "]]\n[[Category:" + fam[1] + "| ]]";
	$('#ans_txt').val(result);
}
</script>
